{% extends "base.html" %}

{% block title %}Setup Wizard - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.wizard-container {
    max-width: 1000px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

.wizard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.wizard-progress {
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    height: 8px;
    margin: 20px 0;
    overflow: hidden;
}

.wizard-progress-bar {
    background: white;
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 10px;
}

.wizard-steps {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 20px;
}

.wizard-step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.wizard-step-indicator.active {
    background: white;
    color: #667eea;
    transform: scale(1.1);
}

.wizard-step-indicator.completed {
    background: #28a745;
    color: white;
}

.wizard-body {
    padding: 40px;
}

.wizard-step-content {
    display: none;
    animation: fadeIn 0.5s ease;
}

.wizard-step-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.wizard-navigation {
    padding: 30px 40px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.setup-option {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.setup-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
    transform: translateY(-2px);
}

.setup-option.selected {
    border-color: #667eea;
    background: #f8f9ff;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
}

.setup-option i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #667eea;
}

.setup-option h5 {
    margin-bottom: 10px;
    color: #495057;
}

.setup-option p {
    color: #6c757d;
    margin-bottom: 0;
}

.config-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.feature-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.feature-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.feature-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-switch.active {
    background: #667eea;
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-switch.active::after {
    transform: translateX(26px);
}

.command-box {
    background: #2d3748;
    color: #e2e8f0;
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    position: relative;
}

.command-box .copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #4a5568;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 0.75rem;
    cursor: pointer;
}

.command-box .copy-btn:hover {
    background: #2d3748;
}

.wizard-summary {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    margin: 20px 0;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.summary-item:last-child {
    border-bottom: none;
}

.completion-animation {
    text-align: center;
    padding: 40px;
}

.completion-animation i {
    font-size: 4rem;
    color: #28a745;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.quick-start-card {
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 25px;
    margin: 15px 0;
    background: white;
}

.quick-start-card h6 {
    color: #667eea;
    margin-bottom: 15px;
}

.access-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #667eea;
    text-decoration: none;
    padding: 8px 16px;
    border: 1px solid #667eea;
    border-radius: 6px;
    margin: 5px;
    transition: all 0.3s ease;
}

.access-link:hover {
    background: #667eea;
    color: white;
    text-decoration: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="wizard-container">
        <!-- Wizard Header -->
        <div class="wizard-header">
            <h2 class="mb-0">PlexiChat Setup Wizard</h2>
            <p class="mb-0">Let's get your PlexiChat instance configured perfectly</p>
            
            <!-- Progress Bar -->
            <div class="wizard-progress">
                <div class="wizard-progress-bar" id="wizardProgress" style="width: 16.67%"></div>
            </div>
            
            <!-- Step Indicators -->
            <div class="wizard-steps">
                <div class="wizard-step-indicator active" id="step-1">1</div>
                <div class="wizard-step-indicator" id="step-2">2</div>
                <div class="wizard-step-indicator" id="step-3">3</div>
                <div class="wizard-step-indicator" id="step-4">4</div>
                <div class="wizard-step-indicator" id="step-5">5</div>
                <div class="wizard-step-indicator" id="step-6">6</div>
            </div>
        </div>

        <!-- Wizard Body -->
        <div class="wizard-body">
            <!-- Step 1: Welcome & Setup Type -->
            <div class="wizard-step-content active" id="content-1">
                <h3 class="text-center mb-4">Welcome to PlexiChat!</h3>
                <p class="text-center text-muted mb-4">Choose your setup type to get started</p>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="setup-option" onclick="selectSetupType('quick')">
                            <i class="fas fa-bolt"></i>
                            <h5>Quick Setup</h5>
                            <p>Get started in 2 minutes with sensible defaults</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="setup-option" onclick="selectSetupType('guided')">
                            <i class="fas fa-hand-holding-heart"></i>
                            <h5>Guided Setup</h5>
                            <p>Step-by-step configuration with explanations</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="setup-option" onclick="selectSetupType('advanced')">
                            <i class="fas fa-cogs"></i>
                            <h5>Advanced Setup</h5>
                            <p>Full control over all configuration options</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Basic Configuration -->
            <div class="wizard-step-content" id="content-2">
                <h3 class="mb-4">Basic Configuration</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="serverName" class="form-label">Server Name</label>
                            <input type="text" class="form-control" id="serverName" 
                                   placeholder="My PlexiChat Server" value="PlexiChat Server">
                        </div>
                        
                        <div class="mb-3">
                            <label for="serverHost" class="form-label">Host Address</label>
                            <input type="text" class="form-control" id="serverHost" 
                                   placeholder="0.0.0.0" value="0.0.0.0">
                            <div class="form-text">Use 0.0.0.0 to accept connections from any IP</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="serverPort" class="form-label">Port Number</label>
                            <input type="number" class="form-control" id="serverPort" 
                                   placeholder="8000" value="8000" min="1" max="65535">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="adminUsername" class="form-label">Admin Username</label>
                            <input type="text" class="form-control" id="adminUsername" 
                                   placeholder="admin" value="admin">
                        </div>
                        
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">Admin Password</label>
                            <input type="password" class="form-control" id="adminPassword" 
                                   placeholder="Enter secure password">
                            <div class="form-text">Minimum 8 characters recommended</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="adminEmail" class="form-label">Admin Email</label>
                            <input type="email" class="form-control" id="adminEmail" 
                                   placeholder="admin@example.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Features Selection -->
            <div class="wizard-step-content" id="content-3">
                <h3 class="mb-4">Choose Features</h3>
                <p class="text-muted mb-4">Select the features you want to enable</p>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <i class="fas fa-network-wired fa-2x text-primary mb-3"></i>
                        <h6>Multi-Server Clustering</h6>
                        <p class="small text-muted">Automatically discover and coordinate with other PlexiChat instances</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch active" onclick="toggleFeature(this, 'clustering')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <i class="fas fa-sync-alt fa-2x text-success mb-3"></i>
                        <h6>Hot Updates</h6>
                        <p class="small text-muted">Update PlexiChat without downtime</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch active" onclick="toggleFeature(this, 'hot_updates')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <i class="fas fa-file-upload fa-2x text-info mb-3"></i>
                        <h6>File Uploads</h6>
                        <p class="small text-muted">Allow users to upload and share files</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch active" onclick="toggleFeature(this, 'file_uploads')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <i class="fas fa-chart-line fa-2x text-warning mb-3"></i>
                        <h6>Analytics</h6>
                        <p class="small text-muted">Collect usage statistics and performance metrics</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch active" onclick="toggleFeature(this, 'analytics')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <i class="fas fa-shield-alt fa-2x text-danger mb-3"></i>
                        <h6>HTTPS Encryption</h6>
                        <p class="small text-muted">Secure connections with SSL/TLS</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch" onclick="toggleFeature(this, 'https')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <i class="fas fa-tachometer-alt fa-2x text-secondary mb-3"></i>
                        <h6>Rate Limiting</h6>
                        <p class="small text-muted">Prevent API abuse with request limits</p>
                        <div class="feature-toggle">
                            <span>Disabled</span>
                            <div class="toggle-switch active" onclick="toggleFeature(this, 'rate_limiting')"></div>
                            <span>Enabled</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Database Setup -->
            <div class="wizard-step-content" id="content-4">
                <h3 class="mb-4">Database Configuration</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Database Type</h5>
                        <div class="setup-option" onclick="selectDatabase('sqlite')">
                            <i class="fas fa-database"></i>
                            <h6>SQLite (Recommended)</h6>
                            <p>Simple, file-based database. Perfect for most use cases.</p>
                        </div>
                        
                        <div class="setup-option" onclick="selectDatabase('postgresql')">
                            <i class="fas fa-server"></i>
                            <h6>PostgreSQL</h6>
                            <p>Advanced database for high-performance deployments.</p>
                        </div>
                        
                        <div class="setup-option" onclick="selectDatabase('mysql')">
                            <i class="fas fa-database"></i>
                            <h6>MySQL/MariaDB</h6>
                            <p>Popular database for web applications.</p>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div id="databaseConfig">
                            <h5>SQLite Configuration</h5>
                            <div class="mb-3">
                                <label for="sqliteFile" class="form-label">Database File</label>
                                <input type="text" class="form-control" id="sqliteFile" 
                                       value="./data/plexichat.db" readonly>
                                <div class="form-text">SQLite database will be created automatically</div>
                            </div>
                            
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>SQLite Benefits</h6>
                                <ul class="mb-0">
                                    <li>No additional setup required</li>
                                    <li>Automatic backups</li>
                                    <li>Perfect for single-server deployments</li>
                                    <li>Easy to migrate later</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Security Setup -->
            <div class="wizard-step-content" id="content-5">
                <h3 class="mb-4">Security Configuration</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Authentication Settings</h5>
                        
                        <div class="mb-3">
                            <label for="jwtExpiry" class="form-label">Session Duration (minutes)</label>
                            <input type="number" class="form-control" id="jwtExpiry" 
                                   value="30" min="5" max="1440">
                            <div class="form-text">How long users stay logged in</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="passwordMinLength" class="form-label">Minimum Password Length</label>
                            <input type="number" class="form-control" id="passwordMinLength" 
                                   value="8" min="4" max="128">
                        </div>
                        
                        <div class="mb-3">
                            <label for="maxLoginAttempts" class="form-label">Max Login Attempts</label>
                            <input type="number" class="form-control" id="maxLoginAttempts" 
                                   value="5" min="1" max="20">
                            <div class="form-text">Account lockout after failed attempts</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Rate Limiting</h5>
                        
                        <div class="mb-3">
                            <label for="rateLimitRequests" class="form-label">Requests per Window</label>
                            <input type="number" class="form-control" id="rateLimitRequests" 
                                   value="100" min="10" max="10000">
                        </div>
                        
                        <div class="mb-3">
                            <label for="rateLimitWindow" class="form-label">Window Duration (seconds)</label>
                            <input type="number" class="form-control" id="rateLimitWindow" 
                                   value="60" min="1" max="3600">
                        </div>
                        
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>HTTPS Setup</h6>
                            <p class="mb-2">HTTPS is currently disabled. You can enable it later through:</p>
                            <ul class="mb-0">
                                <li>Admin Panel → Security → HTTPS Setup</li>
                                <li>Let's Encrypt automatic certificates</li>
                                <li>Self-signed certificates for testing</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Review & Complete -->
            <div class="wizard-step-content" id="content-6">
                <h3 class="mb-4">Review Configuration</h3>
                
                <div class="wizard-summary">
                    <h5 class="mb-3">Configuration Summary</h5>
                    <div id="configSummary">
                        <!-- Summary will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="config-preview">
                    <h6>Generated Configuration Preview:</h6>
                    <pre id="configPreview"></pre>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>What happens next?</h6>
                    <ol class="mb-0">
                        <li>Configuration will be saved to <code>config/plexichat.yaml</code></li>
                        <li>PlexiChat will restart with new settings</li>
                        <li>You'll be redirected to the login page</li>
                        <li>Use your admin credentials to access the system</li>
                    </ol>
                </div>
            </div>

            <!-- Completion Step -->
            <div class="wizard-step-content" id="content-complete" style="display: none;">
                <div class="completion-animation">
                    <i class="fas fa-check-circle"></i>
                    <h3 class="mt-3 mb-4">Setup Complete!</h3>
                    <p class="text-muted mb-4">PlexiChat has been configured successfully</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="quick-start-card">
                            <h6><i class="fas fa-rocket me-2"></i>Quick Access</h6>
                            <a href="/" class="access-link">
                                <i class="fas fa-home"></i>
                                Main Dashboard
                            </a>
                            <a href="/admin" class="access-link">
                                <i class="fas fa-cogs"></i>
                                Admin Panel
                            </a>
                            <a href="/docs" class="access-link">
                                <i class="fas fa-book"></i>
                                API Documentation
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="quick-start-card">
                            <h6><i class="fas fa-terminal me-2"></i>Command Line</h6>
                            <div class="command-box">
                                <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
# Check status
python run.py --validate

# View logs
python cli.py
> monitor logs

# Restart server
python run.py --restart
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg" onclick="finishSetup()">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Go to Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Wizard Navigation -->
        <div class="wizard-navigation">
            <button class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" disabled>
                <i class="fas fa-chevron-left me-1"></i>
                Previous
            </button>
            
            <div class="text-muted">
                Step <span id="currentStep">1</span> of 6
            </div>
            
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class="fas fa-chevron-right ms-1"></i>
            </button>
        </div>
    </div>
</div>

<script>
let currentStepNumber = 1;
let totalSteps = 6;
let wizardConfig = {
    setupType: null,
    server: {
        name: 'PlexiChat Server',
        host: '0.0.0.0',
        port: 8000
    },
    admin: {
        username: 'admin',
        password: '',
        email: ''
    },
    features: {
        clustering: true,
        hot_updates: true,
        file_uploads: true,
        analytics: true,
        https: false,
        rate_limiting: true
    },
    database: {
        type: 'sqlite',
        url: './data/plexichat.db'
    },
    security: {
        jwt_expire_minutes: 30,
        password_min_length: 8,
        max_login_attempts: 5,
        rate_limit_requests: 100,
        rate_limit_window: 60
    }
};

// Initialize wizard
document.addEventListener('DOMContentLoaded', function() {
    updateStepDisplay();
    updateNavigationButtons();
});

// Select setup type
function selectSetupType(type) {
    wizardConfig.setupType = type;

    // Remove selection from all options
    document.querySelectorAll('.setup-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Add selection to clicked option
    event.currentTarget.classList.add('selected');

    // Enable next button
    document.getElementById('nextBtn').disabled = false;

    // Apply quick setup defaults if selected
    if (type === 'quick') {
        applyQuickSetupDefaults();
    }
}

// Apply quick setup defaults
function applyQuickSetupDefaults() {
    // Use sensible defaults for quick setup
    wizardConfig.features.https = false; // Keep simple for quick setup
    wizardConfig.database.type = 'sqlite'; // Simplest option
}

// Navigate to next step
function nextStep() {
    if (!validateCurrentStep()) {
        return;
    }

    collectCurrentStepData();

    if (currentStepNumber < totalSteps) {
        currentStepNumber++;
        updateStepDisplay();
        updateNavigationButtons();
        updateProgress();

        // Special handling for certain steps
        if (currentStepNumber === 6) {
            generateConfigSummary();
        }
    } else {
        // Final step - apply configuration
        applyConfiguration();
    }
}

// Navigate to previous step
function previousStep() {
    if (currentStepNumber > 1) {
        currentStepNumber--;
        updateStepDisplay();
        updateNavigationButtons();
        updateProgress();
    }
}

// Update step display
function updateStepDisplay() {
    // Hide all step contents
    document.querySelectorAll('.wizard-step-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show current step content
    document.getElementById(`content-${currentStepNumber}`).classList.add('active');

    // Update step indicators
    document.querySelectorAll('.wizard-step-indicator').forEach((indicator, index) => {
        indicator.classList.remove('active', 'completed');

        if (index + 1 < currentStepNumber) {
            indicator.classList.add('completed');
            indicator.innerHTML = '✓';
        } else if (index + 1 === currentStepNumber) {
            indicator.classList.add('active');
            indicator.innerHTML = index + 1;
        } else {
            indicator.innerHTML = index + 1;
        }
    });

    // Update step counter
    document.getElementById('currentStep').textContent = currentStepNumber;
}

// Update navigation buttons
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Previous button
    prevBtn.disabled = currentStepNumber === 1;

    // Next button text and state
    if (currentStepNumber === totalSteps) {
        nextBtn.innerHTML = '<i class="fas fa-check me-1"></i>Complete Setup';
        nextBtn.className = 'btn btn-success';
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ms-1"></i>';
        nextBtn.className = 'btn btn-primary';
    }

    // Disable next button if setup type not selected on first step
    if (currentStepNumber === 1 && !wizardConfig.setupType) {
        nextBtn.disabled = true;
    } else {
        nextBtn.disabled = false;
    }
}

// Update progress bar
function updateProgress() {
    const progress = (currentStepNumber / totalSteps) * 100;
    document.getElementById('wizardProgress').style.width = progress + '%';
}

// Validate current step
function validateCurrentStep() {
    switch (currentStepNumber) {
        case 1:
            if (!wizardConfig.setupType) {
                showNotification('Please select a setup type', 'warning');
                return false;
            }
            break;

        case 2:
            const adminPassword = document.getElementById('adminPassword').value;
            if (!adminPassword || adminPassword.length < 8) {
                showNotification('Admin password must be at least 8 characters', 'warning');
                return false;
            }
            break;

        case 3:
            // Features step - no validation needed
            break;

        case 4:
            // Database step - no validation needed for SQLite
            break;

        case 5:
            // Security step - validate numeric inputs
            const jwtExpiry = parseInt(document.getElementById('jwtExpiry').value);
            if (jwtExpiry < 5 || jwtExpiry > 1440) {
                showNotification('Session duration must be between 5 and 1440 minutes', 'warning');
                return false;
            }
            break;
    }

    return true;
}

// Collect data from current step
function collectCurrentStepData() {
    switch (currentStepNumber) {
        case 2:
            wizardConfig.server.name = document.getElementById('serverName').value;
            wizardConfig.server.host = document.getElementById('serverHost').value;
            wizardConfig.server.port = parseInt(document.getElementById('serverPort').value);
            wizardConfig.admin.username = document.getElementById('adminUsername').value;
            wizardConfig.admin.password = document.getElementById('adminPassword').value;
            wizardConfig.admin.email = document.getElementById('adminEmail').value;
            break;

        case 5:
            wizardConfig.security.jwt_expire_minutes = parseInt(document.getElementById('jwtExpiry').value);
            wizardConfig.security.password_min_length = parseInt(document.getElementById('passwordMinLength').value);
            wizardConfig.security.max_login_attempts = parseInt(document.getElementById('maxLoginAttempts').value);
            wizardConfig.security.rate_limit_requests = parseInt(document.getElementById('rateLimitRequests').value);
            wizardConfig.security.rate_limit_window = parseInt(document.getElementById('rateLimitWindow').value);
            break;
    }
}

// Toggle feature
function toggleFeature(element, feature) {
    element.classList.toggle('active');
    wizardConfig.features[feature] = element.classList.contains('active');
}

// Select database type
function selectDatabase(type) {
    wizardConfig.database.type = type;

    // Remove selection from all options
    document.querySelectorAll('#content-4 .setup-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Add selection to clicked option
    event.currentTarget.classList.add('selected');

    // Update database config display
    updateDatabaseConfig(type);
}

// Update database configuration display
function updateDatabaseConfig(type) {
    const configDiv = document.getElementById('databaseConfig');

    switch (type) {
        case 'sqlite':
            configDiv.innerHTML = `
                <h5>SQLite Configuration</h5>
                <div class="mb-3">
                    <label for="sqliteFile" class="form-label">Database File</label>
                    <input type="text" class="form-control" id="sqliteFile"
                           value="./data/plexichat.db" readonly>
                    <div class="form-text">SQLite database will be created automatically</div>
                </div>

                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>SQLite Benefits</h6>
                    <ul class="mb-0">
                        <li>No additional setup required</li>
                        <li>Automatic backups</li>
                        <li>Perfect for single-server deployments</li>
                        <li>Easy to migrate later</li>
                    </ul>
                </div>
            `;
            wizardConfig.database.url = './data/plexichat.db';
            break;

        case 'postgresql':
            configDiv.innerHTML = `
                <h5>PostgreSQL Configuration</h5>
                <div class="mb-3">
                    <label for="pgHost" class="form-label">Host</label>
                    <input type="text" class="form-control" id="pgHost" value="localhost">
                </div>
                <div class="mb-3">
                    <label for="pgPort" class="form-label">Port</label>
                    <input type="number" class="form-control" id="pgPort" value="5432">
                </div>
                <div class="mb-3">
                    <label for="pgDatabase" class="form-label">Database Name</label>
                    <input type="text" class="form-control" id="pgDatabase" value="plexichat">
                </div>
                <div class="mb-3">
                    <label for="pgUsername" class="form-label">Username</label>
                    <input type="text" class="form-control" id="pgUsername" value="plexichat">
                </div>
                <div class="mb-3">
                    <label for="pgPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="pgPassword">
                </div>
            `;
            break;

        case 'mysql':
            configDiv.innerHTML = `
                <h5>MySQL Configuration</h5>
                <div class="mb-3">
                    <label for="mysqlHost" class="form-label">Host</label>
                    <input type="text" class="form-control" id="mysqlHost" value="localhost">
                </div>
                <div class="mb-3">
                    <label for="mysqlPort" class="form-label">Port</label>
                    <input type="number" class="form-control" id="mysqlPort" value="3306">
                </div>
                <div class="mb-3">
                    <label for="mysqlDatabase" class="form-label">Database Name</label>
                    <input type="text" class="form-control" id="mysqlDatabase" value="plexichat">
                </div>
                <div class="mb-3">
                    <label for="mysqlUsername" class="form-label">Username</label>
                    <input type="text" class="form-control" id="mysqlUsername" value="plexichat">
                </div>
                <div class="mb-3">
                    <label for="mysqlPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="mysqlPassword">
                </div>
            `;
            break;
    }
}

// Generate configuration summary
function generateConfigSummary() {
    const summaryDiv = document.getElementById('configSummary');
    const previewDiv = document.getElementById('configPreview');

    // Generate summary items
    const summaryItems = [
        { label: 'Setup Type', value: wizardConfig.setupType.charAt(0).toUpperCase() + wizardConfig.setupType.slice(1) },
        { label: 'Server Name', value: wizardConfig.server.name },
        { label: 'Host:Port', value: `${wizardConfig.server.host}:${wizardConfig.server.port}` },
        { label: 'Admin Username', value: wizardConfig.admin.username },
        { label: 'Database Type', value: wizardConfig.database.type.toUpperCase() },
        { label: 'Features Enabled', value: Object.keys(wizardConfig.features).filter(key => wizardConfig.features[key]).length + ' features' }
    ];

    summaryDiv.innerHTML = summaryItems.map(item => `
        <div class="summary-item">
            <strong>${item.label}</strong>
            <span>${item.value}</span>
        </div>
    `).join('');

    // Generate configuration preview
    const configPreview = {
        server: wizardConfig.server,
        database: wizardConfig.database,
        security: wizardConfig.security,
        features: wizardConfig.features
    };

    previewDiv.textContent = JSON.stringify(configPreview, null, 2);
}

// Apply configuration
async function applyConfiguration() {
    const nextBtn = document.getElementById('nextBtn');
    const originalText = nextBtn.innerHTML;

    nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying Configuration...';
    nextBtn.disabled = true;

    try {
        const response = await fetch('/api/v1/setup/apply', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(wizardConfig)
        });

        const result = await response.json();

        if (result.success) {
            // Show completion step
            document.getElementById(`content-${currentStepNumber}`).classList.remove('active');
            document.getElementById('content-complete').style.display = 'block';

            // Update progress to 100%
            document.getElementById('wizardProgress').style.width = '100%';

            // Hide navigation
            document.querySelector('.wizard-navigation').style.display = 'none';

            showNotification('Configuration applied successfully!', 'success');
        } else {
            showNotification('Configuration failed: ' + result.message, 'error');
            nextBtn.innerHTML = originalText;
            nextBtn.disabled = false;
        }
    } catch (error) {
        console.error('Configuration application failed:', error);
        showNotification('Configuration failed: ' + error.message, 'error');
        nextBtn.innerHTML = originalText;
        nextBtn.disabled = false;
    }
}

// Finish setup and redirect to login
function finishSetup() {
    // Redirect to login page
    window.location.href = '/login';
}

// Copy command to clipboard
function copyToClipboard(button) {
    const commandBox = button.parentElement;
    const command = commandBox.textContent.replace('Copy', '').trim();

    navigator.clipboard.writeText(command).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.style.background = '#28a745';

        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '#4a5568';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        showNotification('Failed to copy to clipboard', 'error');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Handle keyboard navigation
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        const nextBtn = document.getElementById('nextBtn');
        if (!nextBtn.disabled) {
            nextStep();
        }
    } else if (event.key === 'Escape') {
        if (confirm('Are you sure you want to exit the setup wizard?')) {
            window.location.href = '/';
        }
    }
});

// Auto-save configuration to localStorage
function autoSaveConfig() {
    localStorage.setItem('plexichat_wizard_config', JSON.stringify(wizardConfig));
}

// Load saved configuration from localStorage
function loadSavedConfig() {
    const saved = localStorage.getItem('plexichat_wizard_config');
    if (saved) {
        try {
            const savedConfig = JSON.parse(saved);
            wizardConfig = { ...wizardConfig, ...savedConfig };
        } catch (error) {
            console.error('Failed to load saved config:', error);
        }
    }
}

// Initialize auto-save
setInterval(autoSaveConfig, 5000); // Save every 5 seconds

// Load saved config on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedConfig();
});
</script>
{% endblock %}
