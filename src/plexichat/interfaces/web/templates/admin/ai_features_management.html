<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Features Management - PlexiChat Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        .feature-card {
            transition: transform 0.2s ease-in-out;
            border-left: 4px solid #007bff;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .test-area {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .result-display {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .nav-pills .nav-link.active {
            background-color: #007bff;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="fas fa-brain text-primary me-2"></i>
                            AI-Powered Features Management
                        </h1>
                        <p class="text-muted mb-0">Manage smart summarization, content suggestions, sentiment analysis, and more</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showConfigModal()">
                            <i class="fas fa-cog"></i> Configure
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-heartbeat fa-2x mb-2"></i>
                        <h5>Service Status</h5>
                        <span class="status-indicator" id="serviceStatus"></span>
                        <span id="serviceStatusText">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h5>Total Requests</h5>
                        <h3 id="totalRequests">-</h3>
                        <small>All features combined</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h5>Success Rate</h5>
                        <h3 id="successRate">-</h3>
                        <small>Overall performance</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h5>Avg Response</h5>
                        <h3 id="avgResponse">-</h3>
                        <small>Processing time</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-pills mb-3" id="featureTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-tachometer-alt me-1"></i> Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summarization-tab" data-bs-toggle="pill" data-bs-target="#summarization" type="button" role="tab">
                            <i class="fas fa-compress-alt me-1"></i> Summarization
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="suggestions-tab" data-bs-toggle="pill" data-bs-target="#suggestions" type="button" role="tab">
                            <i class="fas fa-lightbulb me-1"></i> Content Suggestions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sentiment-tab" data-bs-toggle="pill" data-bs-target="#sentiment" type="button" role="tab">
                            <i class="fas fa-smile me-1"></i> Sentiment Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="search-tab" data-bs-toggle="pill" data-bs-target="#search" type="button" role="tab">
                            <i class="fas fa-search me-1"></i> Semantic Search
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="moderation-tab" data-bs-toggle="pill" data-bs-target="#moderation" type="button" role="tab">
                            <i class="fas fa-shield-alt me-1"></i> Moderation
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="featureTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <!-- Feature Status Cards -->
                            <div class="col-md-6 mb-3">
                                <div class="card feature-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-compress-alt text-primary me-2"></i>Smart Summarization</h6>
                                        <span class="badge bg-success" id="summarizationStatus">Enabled</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Requests</small>
                                                <div class="h5" id="summarizationRequests">-</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Success Rate</small>
                                                <div class="h5" id="summarizationSuccess">-</div>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar" id="summarizationProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="card feature-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-lightbulb text-warning me-2"></i>Content Suggestions</h6>
                                        <span class="badge bg-success" id="suggestionsStatus">Enabled</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Requests</small>
                                                <div class="h5" id="suggestionsRequests">-</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Success Rate</small>
                                                <div class="h5" id="suggestionsSuccess">-</div>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar bg-warning" id="suggestionsProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="card feature-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-smile text-info me-2"></i>Sentiment Analysis</h6>
                                        <span class="badge bg-success" id="sentimentStatus">Enabled</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Requests</small>
                                                <div class="h5" id="sentimentRequests">-</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Success Rate</small>
                                                <div class="h5" id="sentimentSuccess">-</div>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar bg-info" id="sentimentProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="card feature-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-search text-success me-2"></i>Semantic Search</h6>
                                        <span class="badge bg-success" id="searchStatus">Enabled</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Indexed Docs</small>
                                                <div class="h5" id="searchIndexSize">-</div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Cache Size</small>
                                                <div class="h5" id="searchCacheSize">-</div>
                                            </div>
                                        </div>
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar bg-success" id="searchProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cache Information -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-database text-primary me-2"></i>Cache Status</h6>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllCache()">
                                            <i class="fas fa-trash"></i> Clear All Cache
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="cacheStatus">
                                            <!-- Cache status will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summarization Tab -->
                    <div class="tab-pane fade" id="summarization" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-compress-alt text-primary me-2"></i>Smart Summarization Testing</h6>
                            </div>
                            <div class="card-body">
                                <div class="test-area">
                                    <div class="mb-3">
                                        <label for="summaryText" class="form-label">Text to Summarize</label>
                                        <textarea class="form-control" id="summaryText" rows="6" placeholder="Enter text to summarize..."></textarea>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="summaryType" class="form-label">Summary Type</label>
                                            <select class="form-select" id="summaryType">
                                                <option value="brief">Brief Summary</option>
                                                <option value="detailed">Detailed Summary</option>
                                                <option value="bullet_points">Bullet Points</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="maxLength" class="form-label">Max Length (words)</label>
                                            <input type="number" class="form-control" id="maxLength" placeholder="Optional" min="50" max="1000">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="testSummarization()">
                                        <i class="fas fa-play"></i> Generate Summary
                                    </button>
                                    <div id="summaryResult" class="result-display" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Suggestions Tab -->
                    <div class="tab-pane fade" id="suggestions" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-lightbulb text-warning me-2"></i>Content Suggestions Testing</h6>
                            </div>
                            <div class="card-body">
                                <div class="test-area">
                                    <div class="mb-3">
                                        <label for="suggestionContext" class="form-label">Context</label>
                                        <textarea class="form-control" id="suggestionContext" rows="4" placeholder="Enter context for suggestions..."></textarea>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="suggestionType" class="form-label">Suggestion Type</label>
                                            <select class="form-select" id="suggestionType">
                                                <option value="completion">Text Completion</option>
                                                <option value="improvement">Text Improvement</option>
                                                <option value="alternative">Alternative Phrasing</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="maxSuggestions" class="form-label">Max Suggestions</label>
                                            <input type="number" class="form-control" id="maxSuggestions" value="3" min="1" max="10">
                                        </div>
                                    </div>
                                    <button class="btn btn-warning" onclick="testContentSuggestions()">
                                        <i class="fas fa-play"></i> Generate Suggestions
                                    </button>
                                    <div id="suggestionsResult" class="result-display" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment Analysis Tab -->
                    <div class="tab-pane fade" id="sentiment" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-smile text-info me-2"></i>Sentiment Analysis Testing</h6>
                            </div>
                            <div class="card-body">
                                <div class="test-area">
                                    <div class="mb-3">
                                        <label for="sentimentText" class="form-label">Text to Analyze</label>
                                        <textarea class="form-control" id="sentimentText" rows="4" placeholder="Enter text for sentiment analysis..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeEmotions" checked>
                                            <label class="form-check-label" for="includeEmotions">
                                                Include Emotion Analysis
                                            </label>
                                        </div>
                                    </div>
                                    <button class="btn btn-info" onclick="testSentimentAnalysis()">
                                        <i class="fas fa-play"></i> Analyze Sentiment
                                    </button>
                                    <div id="sentimentResult" class="result-display" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Semantic Search Tab -->
                    <div class="tab-pane fade" id="search" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-plus text-success me-2"></i>Add to Search Index</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="indexContentId" class="form-label">Content ID</label>
                                            <input type="text" class="form-control" id="indexContentId" placeholder="Unique identifier">
                                        </div>
                                        <div class="mb-3">
                                            <label for="indexContent" class="form-label">Content</label>
                                            <textarea class="form-control" id="indexContent" rows="4" placeholder="Content to index..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="indexMetadata" class="form-label">Metadata (JSON)</label>
                                            <textarea class="form-control" id="indexMetadata" rows="2" placeholder='{"category": "example", "tags": ["tag1", "tag2"]}'></textarea>
                                        </div>
                                        <button class="btn btn-success" onclick="addToIndex()">
                                            <i class="fas fa-plus"></i> Add to Index
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-search text-primary me-2"></i>Semantic Search Testing</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="searchQuery" class="form-label">Search Query</label>
                                            <input type="text" class="form-control" id="searchQuery" placeholder="Enter search query...">
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label for="maxResults" class="form-label">Max Results</label>
                                                <input type="number" class="form-control" id="maxResults" value="10" min="1" max="50">
                                            </div>
                                            <div class="col-6">
                                                <label for="similarityThreshold" class="form-label">Similarity Threshold</label>
                                                <input type="number" class="form-control" id="similarityThreshold" value="0.3" min="0" max="1" step="0.1">
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" onclick="testSemanticSearch()">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div id="searchResults" style="display: none;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Search Results</h6>
                                        </div>
                                        <div class="card-body" id="searchResultsContent">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Moderation Tab -->
                    <div class="tab-pane fade" id="moderation" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-shield-alt text-danger me-2"></i>Content Moderation Testing</h6>
                            </div>
                            <div class="card-body">
                                <div class="test-area">
                                    <div class="mb-3">
                                        <label for="moderationContent" class="form-label">Content to Moderate</label>
                                        <textarea class="form-control" id="moderationContent" rows="4" placeholder="Enter content for moderation..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="moderationMetadata" class="form-label">Metadata (JSON, optional)</label>
                                        <textarea class="form-control" id="moderationMetadata" rows="2" placeholder='{"user_id": "123", "context": "chat"}'></textarea>
                                    </div>
                                    <button class="btn btn-danger" onclick="testContentModeration()">
                                        <i class="fas fa-shield-alt"></i> Moderate Content
                                    </button>
                                    <div id="moderationResult" class="result-display" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">AI Features Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="configEditor" class="form-label">Configuration (YAML/JSON)</label>
                        <textarea class="form-control" id="configEditor" rows="20" style="font-family: monospace;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script>
        // Global variables
        let currentStats = {};
        let currentHealth = {};
        let loadingModal;
        let configModal;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            configModal = new bootstrap.Modal(document.getElementById('configModal'));

            // Load initial data
            refreshDashboard();

            // Set up auto-refresh
            setInterval(refreshDashboard, 30000); // Refresh every 30 seconds
        });

        // Dashboard functions
        async function refreshDashboard() {
            try {
                // Load statistics
                const statsResponse = await fetch('/admin/ai-features/api/statistics');
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    currentStats = statsData.statistics;
                    updateOverviewMetrics();
                    updateFeatureCards();
                    updateCacheStatus();
                }

                // Load health status
                const healthResponse = await fetch('/admin/ai-features/api/health');
                const healthData = await healthResponse.json();

                if (healthData.success) {
                    currentHealth = healthData.health;
                    updateServiceStatus();
                }

            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                showAlert('Failed to refresh dashboard data', 'error');
            }
        }

        function updateOverviewMetrics() {
            const stats = currentStats.feature_stats || {};

            // Calculate totals
            let totalRequests = 0;
            let totalSuccesses = 0;
            let totalProcessingTime = 0;
            let requestCount = 0;

            Object.values(stats).forEach(featureStats => {
                totalRequests += featureStats.requests || 0;
                totalSuccesses += featureStats.successes || 0;
                totalProcessingTime += featureStats.total_processing_time || 0;
                if (featureStats.requests > 0) requestCount++;
            });

            // Update metrics
            document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();

            const successRate = totalRequests > 0 ? ((totalSuccesses / totalRequests) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('successRate').textContent = successRate;

            const avgResponse = requestCount > 0 ? (totalProcessingTime / requestCount).toFixed(0) + 'ms' : '0ms';
            document.getElementById('avgResponse').textContent = avgResponse;
        }

        function updateServiceStatus() {
            const serviceState = currentHealth.service_state || 'unknown';
            const statusElement = document.getElementById('serviceStatus');
            const statusTextElement = document.getElementById('serviceStatusText');

            statusElement.className = 'status-indicator';

            switch (serviceState.toLowerCase()) {
                case 'running':
                    statusElement.classList.add('status-healthy');
                    statusTextElement.textContent = 'Running';
                    break;
                case 'starting':
                    statusElement.classList.add('status-warning');
                    statusTextElement.textContent = 'Starting';
                    break;
                case 'stopped':
                case 'error':
                    statusElement.classList.add('status-error');
                    statusTextElement.textContent = 'Error';
                    break;
                default:
                    statusElement.classList.add('status-warning');
                    statusTextElement.textContent = 'Unknown';
            }
        }

        function updateFeatureCards() {
            const stats = currentStats.feature_stats || {};
            const features = ['summarization', 'content_suggestions', 'sentiment_analysis', 'semantic_search'];

            features.forEach(feature => {
                const featureStats = stats[feature] || { requests: 0, successes: 0, failures: 0 };
                const requests = featureStats.requests || 0;
                const successes = featureStats.successes || 0;
                const successRate = requests > 0 ? ((successes / requests) * 100).toFixed(1) + '%' : '0%';

                // Update request count
                const requestsElement = document.getElementById(feature.replace('_', '') + 'Requests');
                if (requestsElement) requestsElement.textContent = requests.toLocaleString();

                // Update success rate
                const successElement = document.getElementById(feature.replace('_', '') + 'Success');
                if (successElement) successElement.textContent = successRate;

                // Update progress bar
                const progressElement = document.getElementById(feature.replace('_', '') + 'Progress');
                if (progressElement) {
                    const progressPercent = requests > 0 ? (successes / requests) * 100 : 0;
                    progressElement.style.width = progressPercent + '%';
                }
            });

            // Update semantic search specific metrics
            const cacheSize = currentStats.cache_sizes || {};
            const semanticStats = currentStats.semantic_search || {};

            const indexSizeElement = document.getElementById('searchIndexSize');
            if (indexSizeElement) {
                indexSizeElement.textContent = (semanticStats.indexed_documents || 0).toLocaleString();
            }

            const cacheSizeElement = document.getElementById('searchCacheSize');
            if (cacheSizeElement) {
                cacheSizeElement.textContent = (cacheSize.semantic_index || 0).toLocaleString();
            }
        }

        function updateCacheStatus() {
            const cacheSize = currentStats.cache_sizes || {};
            const cacheStatusElement = document.getElementById('cacheStatus');

            if (!cacheStatusElement) return;

            const cacheTypes = [
                { key: 'summarization', label: 'Summarization', icon: 'fas fa-compress-alt', color: 'primary' },
                { key: 'content_suggestions', label: 'Content Suggestions', icon: 'fas fa-lightbulb', color: 'warning' },
                { key: 'sentiment', label: 'Sentiment Analysis', icon: 'fas fa-smile', color: 'info' },
                { key: 'semantic_index', label: 'Semantic Search', icon: 'fas fa-search', color: 'success' },
                { key: 'moderation', label: 'Moderation', icon: 'fas fa-shield-alt', color: 'danger' }
            ];

            let html = '';
            cacheTypes.forEach(cache => {
                const size = cacheSize[cache.key] || 0;
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="${cache.icon} text-${cache.color} me-2"></i>
                            <span class="me-auto">${cache.label}</span>
                            <span class="badge bg-${cache.color}">${size.toLocaleString()}</span>
                            <button class="btn btn-sm btn-outline-${cache.color} ms-2" onclick="clearCache('${cache.key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            cacheStatusElement.innerHTML = html;
        }

        // Testing functions
        async function testSummarization() {
            const text = document.getElementById('summaryText').value.trim();
            const summaryType = document.getElementById('summaryType').value;
            const maxLength = document.getElementById('maxLength').value;

            if (!text) {
                showAlert('Please enter text to summarize', 'warning');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        summary_type: summaryType,
                        max_length: maxLength ? parseInt(maxLength) : null
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    const result = data.result;
                    const resultHtml = `
                        <h6>Summary Result</h6>
                        <div class="mb-2"><strong>Type:</strong> ${result.summary_type}</div>
                        <div class="mb-2"><strong>Confidence:</strong> ${(result.confidence_score * 100).toFixed(1)}%</div>
                        <div class="mb-2"><strong>Processing Time:</strong> ${result.processing_time_ms.toFixed(0)}ms</div>
                        <div class="mb-2"><strong>Compression:</strong> ${result.word_count_original} → ${result.word_count_summary} words (${(result.compression_ratio * 100).toFixed(1)}%)</div>
                        ${result.key_topics.length > 0 ? `<div class="mb-2"><strong>Key Topics:</strong> ${result.key_topics.join(', ')}</div>` : ''}
                        <div class="mt-3"><strong>Summary:</strong></div>
                        <div class="border p-2 bg-light">${result.summary}</div>
                    `;

                    const resultElement = document.getElementById('summaryResult');
                    resultElement.innerHTML = resultHtml;
                    resultElement.style.display = 'block';
                } else {
                    showAlert('Summarization failed: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Summarization error:', error);
                showAlert('Summarization request failed', 'error');
            }
        }

        async function testContentSuggestions() {
            const context = document.getElementById('suggestionContext').value.trim();
            const suggestionType = document.getElementById('suggestionType').value;
            const maxSuggestions = parseInt(document.getElementById('maxSuggestions').value);

            if (!context) {
                showAlert('Please enter context for suggestions', 'warning');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/suggest-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        context: context,
                        suggestion_type: suggestionType,
                        max_suggestions: maxSuggestions
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    let resultHtml = `<h6>Content Suggestions (${data.suggestions.length})</h6>`;

                    data.suggestions.forEach((suggestion, index) => {
                        resultHtml += `
                            <div class="border p-2 mb-2 bg-light">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <strong>Suggestion ${index + 1}</strong>
                                    <div>
                                        <span class="badge bg-primary">Confidence: ${(suggestion.confidence_score * 100).toFixed(1)}%</span>
                                        <span class="badge bg-secondary">Relevance: ${(suggestion.relevance_score * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div>${suggestion.suggestion}</div>
                            </div>
                        `;
                    });

                    const resultElement = document.getElementById('suggestionsResult');
                    resultElement.innerHTML = resultHtml;
                    resultElement.style.display = 'block';
                } else {
                    showAlert('Content suggestions failed: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Content suggestions error:', error);
                showAlert('Content suggestions request failed', 'error');
            }
        }

        async function testSentimentAnalysis() {
            const text = document.getElementById('sentimentText').value.trim();
            const includeEmotions = document.getElementById('includeEmotions').checked;

            if (!text) {
                showAlert('Please enter text for sentiment analysis', 'warning');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/analyze-sentiment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        include_emotions: includeEmotions
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    const result = data.result;
                    let resultHtml = `
                        <h6>Sentiment Analysis Result</h6>
                        <div class="mb-2"><strong>Sentiment:</strong> <span class="badge bg-${getSentimentColor(result.sentiment)}">${result.sentiment.toUpperCase()}</span></div>
                        <div class="mb-2"><strong>Confidence:</strong> ${(result.confidence_score * 100).toFixed(1)}%</div>
                        <div class="mb-2"><strong>Processing Time:</strong> ${result.processing_time_ms.toFixed(0)}ms</div>
                    `;

                    if (result.emotion_scores && Object.keys(result.emotion_scores).length > 0) {
                        resultHtml += '<div class="mb-2"><strong>Emotions:</strong></div>';
                        Object.entries(result.emotion_scores).forEach(([emotion, score]) => {
                            const percentage = (score * 100).toFixed(1);
                            resultHtml += `
                                <div class="d-flex align-items-center mb-1">
                                    <span class="me-2" style="width: 80px;">${emotion}:</span>
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        <div class="progress-bar" style="width: ${percentage}%">${percentage}%</div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    if (result.key_phrases && result.key_phrases.length > 0) {
                        resultHtml += `<div class="mb-2"><strong>Key Phrases:</strong> ${result.key_phrases.join(', ')}</div>`;
                    }

                    const resultElement = document.getElementById('sentimentResult');
                    resultElement.innerHTML = resultHtml;
                    resultElement.style.display = 'block';
                } else {
                    showAlert('Sentiment analysis failed: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Sentiment analysis error:', error);
                showAlert('Sentiment analysis request failed', 'error');
            }
        }

        function getSentimentColor(sentiment) {
            switch (sentiment.toLowerCase()) {
                case 'positive': return 'success';
                case 'negative': return 'danger';
                case 'neutral': return 'secondary';
                case 'mixed': return 'warning';
                default: return 'secondary';
            }
        }

        async function addToIndex() {
            const contentId = document.getElementById('indexContentId').value.trim();
            const content = document.getElementById('indexContent').value.trim();
            const metadataText = document.getElementById('indexMetadata').value.trim();

            if (!contentId || !content) {
                showAlert('Please enter both Content ID and Content', 'warning');
                return;
            }

            let metadata = {};
            if (metadataText) {
                try {
                    metadata = JSON.parse(metadataText);
                } catch (error) {
                    showAlert('Invalid JSON in metadata field', 'error');
                    return;
                }
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/add-to-index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_id: contentId,
                        content: content,
                        metadata: metadata
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    showAlert('Content added to semantic index successfully', 'success');
                    // Clear form
                    document.getElementById('indexContentId').value = '';
                    document.getElementById('indexContent').value = '';
                    document.getElementById('indexMetadata').value = '';
                } else {
                    showAlert('Failed to add content to index: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Add to index error:', error);
                showAlert('Add to index request failed', 'error');
            }
        }

        async function testSemanticSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const similarityThreshold = parseFloat(document.getElementById('similarityThreshold').value);

            if (!query) {
                showAlert('Please enter a search query', 'warning');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/semantic-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        max_results: maxResults,
                        similarity_threshold: similarityThreshold
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    let resultHtml = `<h6>Search Results (${data.results.length} found)</h6>`;

                    if (data.results.length === 0) {
                        resultHtml += '<p class="text-muted">No results found. Try lowering the similarity threshold or adding more content to the index.</p>';
                    } else {
                        data.results.forEach((result, index) => {
                            resultHtml += `
                                <div class="border p-3 mb-3 bg-light">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <strong>Result ${index + 1}</strong>
                                        <span class="badge bg-primary">Similarity: ${(result.similarity_score * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="mb-2"><strong>Content ID:</strong> ${result.result_id}</div>
                                    <div class="mb-2"><strong>Content:</strong></div>
                                    <div class="border p-2 bg-white">${result.highlighted_text || result.content}</div>
                                    ${Object.keys(result.metadata).length > 0 ? `
                                        <div class="mt-2"><strong>Metadata:</strong></div>
                                        <pre class="bg-white p-2 border">${JSON.stringify(result.metadata, null, 2)}</pre>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }

                    const resultElement = document.getElementById('searchResultsContent');
                    resultElement.innerHTML = resultHtml;
                    document.getElementById('searchResults').style.display = 'block';
                } else {
                    showAlert('Semantic search failed: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Semantic search error:', error);
                showAlert('Semantic search request failed', 'error');
            }
        }

        async function testContentModeration() {
            const content = document.getElementById('moderationContent').value.trim();
            const metadataText = document.getElementById('moderationMetadata').value.trim();

            if (!content) {
                showAlert('Please enter content to moderate', 'warning');
                return;
            }

            let metadata = {};
            if (metadataText) {
                try {
                    metadata = JSON.parse(metadataText);
                } catch (error) {
                    showAlert('Invalid JSON in metadata field', 'error');
                    return;
                }
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/moderate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        metadata: metadata
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    const result = data.result;
                    let resultHtml = `
                        <h6>Moderation Result</h6>
                        <div class="mb-2"><strong>Action:</strong> <span class="badge bg-${getModerationColor(result.action)}">${result.action.toUpperCase()}</span></div>
                        <div class="mb-2"><strong>Confidence:</strong> ${(result.confidence_score * 100).toFixed(1)}%</div>
                        <div class="mb-2"><strong>Severity Score:</strong> ${(result.severity_score * 100).toFixed(1)}%</div>
                        <div class="mb-2"><strong>Processing Time:</strong> ${result.processing_time_ms.toFixed(0)}ms</div>
                    `;

                    if (result.violation_categories && result.violation_categories.length > 0) {
                        resultHtml += `<div class="mb-2"><strong>Violation Categories:</strong> ${result.violation_categories.join(', ')}</div>`;
                    }

                    if (result.explanation) {
                        resultHtml += `<div class="mb-2"><strong>Explanation:</strong></div><div class="border p-2 bg-white">${result.explanation}</div>`;
                    }

                    const resultElement = document.getElementById('moderationResult');
                    resultElement.innerHTML = resultHtml;
                    resultElement.style.display = 'block';
                } else {
                    showAlert('Content moderation failed: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Content moderation error:', error);
                showAlert('Content moderation request failed', 'error');
            }
        }

        function getModerationColor(action) {
            switch (action.toLowerCase()) {
                case 'approve': return 'success';
                case 'flag': return 'warning';
                case 'block': return 'danger';
                case 'review': return 'info';
                default: return 'secondary';
            }
        }

        // Utility functions
        async function clearCache(featureType) {
            if (!confirm(`Are you sure you want to clear the ${featureType} cache?`)) {
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/clear-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feature_type: featureType })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    showAlert(data.message, 'success');
                    refreshDashboard();
                } else {
                    showAlert('Failed to clear cache: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Clear cache error:', error);
                showAlert('Clear cache request failed', 'error');
            }
        }

        async function clearAllCache() {
            if (!confirm('Are you sure you want to clear ALL caches? This action cannot be undone.')) {
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/api/clear-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    showAlert(data.message, 'success');
                    refreshDashboard();
                } else {
                    showAlert('Failed to clear all caches: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Clear all cache error:', error);
                showAlert('Clear all cache request failed', 'error');
            }
        }

        function showConfigModal() {
            // Load current configuration
            fetch('/admin/ai-features/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('configEditor').value = JSON.stringify(data.config, null, 2);
                        configModal.show();
                    } else {
                        showAlert('Failed to load configuration', 'error');
                    }
                })
                .catch(error => {
                    console.error('Config load error:', error);
                    showAlert('Failed to load configuration', 'error');
                });
        }

        async function saveConfiguration() {
            const configText = document.getElementById('configEditor').value.trim();

            if (!configText) {
                showAlert('Configuration cannot be empty', 'warning');
                return;
            }

            let config;
            try {
                config = JSON.parse(configText);
            } catch (error) {
                showAlert('Invalid JSON configuration', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/admin/ai-features/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    showAlert('Configuration saved successfully', 'success');
                    configModal.hide();
                    refreshDashboard();
                } else {
                    showAlert('Failed to save configuration: ' + data.error, 'error');
                }

            } catch (error) {
                hideLoading();
                console.error('Config save error:', error);
                showAlert('Failed to save configuration', 'error');
            }
        }

        function showLoading() {
            loadingModal.show();
        }

        function hideLoading() {
            loadingModal.hide();
        }

        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>