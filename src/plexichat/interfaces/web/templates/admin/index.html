<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlexiChat Admin Panel</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
        }
        
        body {
            background-color: var(--light-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .admin-sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }
        
        .admin-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            min-height: 600px;
        }
        
        .nav-link {
            color: var(--secondary-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(4px);
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: var(--secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-online {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .status-offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .status-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        .btn-modern {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .table-modern {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .table-modern thead {
            background-color: var(--light-color);
        }
        
        .table-modern th {
            border: none;
            padding: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .table-modern td {
            border: none;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        PlexiChat Admin Panel
                    </h1>
                    <p class="mb-0 opacity-75">System Administration & Management</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end align-items-center gap-3">
                        <span class="status-badge status-online">
                            <i class="fas fa-circle me-1"></i>
                            System Online
                        </span>
                        <button class="btn btn-light btn-modern" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="admin-sidebar">
                    <h5 class="mb-3">Navigation</h5>
                    <nav class="nav flex-column">
                        <button class="nav-link active" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </button>
                        <button class="nav-link" onclick="showSection('users')">
                            <i class="fas fa-users me-2"></i>
                            User Management
                        </button>
                        <button class="nav-link" onclick="showSection('security')">
                            <i class="fas fa-shield-alt me-2"></i>
                            Security
                        </button>
                        <button class="nav-link" onclick="showSection('performance')">
                            <i class="fas fa-chart-line me-2"></i>
                            Performance
                        </button>
                        <button class="nav-link" onclick="showSection('cluster')">
                            <i class="fas fa-network-wired me-2"></i>
                            Cluster
                        </button>
                        <button class="nav-link" onclick="showSection('backups')">
                            <i class="fas fa-database me-2"></i>
                            Backups
                        </button>
                        <button class="nav-link" onclick="showSection('logs')">
                            <i class="fas fa-file-alt me-2"></i>
                            Logs
                        </button>
                        <button class="nav-link" onclick="showSection('suggestions')">
                            <i class="fas fa-lightbulb me-2"></i>
                            Suggestions
                        </button>
                        <button class="nav-link" onclick="showSection('filters')">
                            <i class="fas fa-shield-alt me-2"></i>
                            Filters
                        </button>
                        <button class="nav-link" onclick="showSection('system')">
                            <i class="fas fa-server me-2"></i>
                            System Control
                        </button>
                        <button class="nav-link" onclick="showSection('settings')">
                            <i class="fas fa-cog me-2"></i>
                            Settings
                        </button>
                    </nav>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <a href="/" class="btn btn-outline-primary btn-modern w-100 mb-2">
                            <i class="fas fa-home me-1"></i>
                            Back to Main
                        </a>
                        <a href="/docs" class="btn btn-outline-secondary btn-modern w-100 mb-2">
                            <i class="fas fa-book me-1"></i>
                            Documentation
                        </a>
                        <a href="/management" class="btn btn-outline-info btn-modern w-100">
                            <i class="fas fa-chart-bar me-1"></i>
                            Management Console
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="admin-content">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="content-section fade-in">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>System Dashboard</h2>
                            <small class="text-muted">Last updated: <span id="last-update">Never</span></small>
                        </div>

                        <!-- Metrics Row -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="total-users">-</div>
                                    <div class="metric-label">Total Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="active-sessions">-</div>
                                    <div class="metric-label">Active Sessions</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="api-requests">-</div>
                                    <div class="metric-label">API Requests/min</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="security-score">-</div>
                                    <div class="metric-label">Security Score</div>
                                </div>
                            </div>
                        </div>

                        <!-- Plugin Module Permission Management -->
                        <div class="row g-4 mt-4">
                            <div class="col-12">
                                <h5>Plugin Module Permission Requests</h5>
                                <div id="plugin-module-requests-section">
                                    <table class="table table-modern" id="plugin-module-requests-table">
                                        <thead>
                                            <tr>
                                                <th>Plugin</th>
                                                <th>Requested Module</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Requests will be loaded here -->
                                        </tbody>
                                    </table>
                                    <div id="plugin-module-requests-empty" class="text-muted" style="display:none;">No pending module requests.</div>
                                </div>
                            </div>
                        </div>
                        <script>
                        async function fetchPluginModuleRequests() {
                            const res = await fetch('/admin/plugin-module-requests');
                            const data = await res.json();
                            const table = document.getElementById('plugin-module-requests-table').getElementsByTagName('tbody')[0];
                            table.innerHTML = '';
                            let hasRequests = false;
                            for (const [plugin, modules] of Object.entries(data.requests)) {
                                for (const moduleName of modules) {
                                    hasRequests = true;
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${plugin}</td>
                                        <td>${moduleName}</td>
                                        <td>
                                            <button class="btn btn-success btn-sm" onclick="grantPluginModule('${plugin}','${moduleName}')">Grant</button>
                                            <button class="btn btn-danger btn-sm" onclick="revokePluginModule('${plugin}','${moduleName}')">Revoke</button>
                                        </td>
                                    `;
                                    table.appendChild(row);
                                }
                            }
                            document.getElementById('plugin-module-requests-empty').style.display = hasRequests ? 'none' : '';
                        }
                        async function grantPluginModule(plugin, moduleName) {
                            await fetch('/admin/grant-plugin-module', {
                                method: 'POST',
                                body: new URLSearchParams({plugin_name: plugin, module_name: moduleName})
                            });
                            fetchPluginModuleRequests();
                        }
                        async function revokePluginModule(plugin, moduleName) {
                            await fetch('/admin/revoke-plugin-module', {
                                method: 'POST',
                                body: new URLSearchParams({plugin_name: plugin, module_name: moduleName})
                            });
                            fetchPluginModuleRequests();
                        }
                        document.addEventListener('DOMContentLoaded', fetchPluginModuleRequests);
                        </script>

                        <!-- Quick Actions -->
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h5>Quick Actions</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-modern" onclick="runSecurityAudit()">
                                        <i class="fas fa-shield-alt me-2"></i>
                                        Run Security Audit
                                    </button>
                                    <button class="btn btn-success btn-modern" onclick="createBackup()">
                                        <i class="fas fa-database me-2"></i>
                                        Create Backup
                                    </button>
                                    <button class="btn btn-info btn-modern" onclick="runSystemTests()">
                                        <i class="fas fa-vial me-2"></i>
                                        Run System Tests
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>System Status</h5>
                                <div id="system-status">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Server Status</span>
                                        <span class="status-badge status-online">Online</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Database</span>
                                        <span class="status-badge status-online">Connected</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Cache</span>
                                        <span class="status-badge status-online">Active</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Cluster</span>
                                        <span class="status-badge status-online">Healthy</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other sections will be loaded dynamically -->
                    <div id="users-section" class="content-section" style="display: none;">
                        <h2>User Management</h2>
                        <p>User management interface will be loaded here...</p>
                    </div>

                    <div id="security-section" class="content-section" style="display: none;">
                        <h2>Security Management</h2>
                        <p>Security management interface will be loaded here...</p>
                    </div>

                    <div id="performance-section" class="content-section" style="display: none;">
                        <h2>Performance Monitoring</h2>
                        <p>Performance monitoring interface will be loaded here...</p>
                    </div>

                    <div id="cluster-section" class="content-section" style="display: none;">
                        <h2>Cluster Management</h2>
                        <p>Cluster management interface will be loaded here...</p>
                    </div>

                    <div id="backups-section" class="content-section" style="display: none;">
                        <h2>Backup Management</h2>
                        <p>Backup management interface will be loaded here...</p>
                    </div>

                    <div id="logs-section" class="content-section" style="display: none;">
                        <h2>System Logs</h2>
                        <p>System logs interface will be loaded here...</p>
                    </div>

                    <div id="suggestions-section" class="content-section" style="display: none;">
                        <h2>Suggestions Management</h2>
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Recent Suggestions</h5>
                                    <a href="/admin/suggestions" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        Open Full Manager
                                    </a>
                                </div>
                                <div id="recent-suggestions">
                                    <!-- Recent suggestions will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="filters-section" class="content-section" style="display: none;">
                        <h2>Filter Management</h2>
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Content & Username Filters</h5>
                                    <a href="/admin/filters" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        Open Filter Manager
                                    </a>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="metric-value" id="content-rules-count">-</div>
                                            <div class="metric-label">Content Rules</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="metric-value" id="username-rules-count">-</div>
                                            <div class="metric-label">Username Rules</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="system-section" class="content-section" style="display: none;">
                        <h2>System Control</h2>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h5>Application Control</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-warning btn-modern" onclick="restartApplication()">
                                        <i class="fas fa-redo me-2"></i>
                                        Restart Application
                                    </button>
                                    <button class="btn btn-info btn-modern" onclick="reloadConfiguration()">
                                        <i class="fas fa-sync me-2"></i>
                                        Reload Configuration
                                    </button>
                                    <button class="btn btn-success btn-modern" onclick="checkForUpdates()">
                                        <i class="fas fa-download me-2"></i>
                                        Check for Updates
                                    </button>
                                    <button class="btn btn-primary btn-modern" onclick="updateApplication()">
                                        <i class="fas fa-arrow-up me-2"></i>
                                        Update Application
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>System Maintenance</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-secondary btn-modern" onclick="clearCache()">
                                        <i class="fas fa-broom me-2"></i>
                                        Clear Cache
                                    </button>
                                    <button class="btn btn-info btn-modern" onclick="optimizeDatabase()">
                                        <i class="fas fa-database me-2"></i>
                                        Optimize Database
                                    </button>
                                    <button class="btn btn-warning btn-modern" onclick="cleanupLogs()">
                                        <i class="fas fa-trash me-2"></i>
                                        Cleanup Old Logs
                                    </button>
                                    <button class="btn btn-danger btn-modern" onclick="emergencyShutdown()">
                                        <i class="fas fa-power-off me-2"></i>
                                        Emergency Shutdown
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <h5>System Status</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-value" id="system-uptime">-</div>
                                            <div class="metric-label">Uptime</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-value" id="system-version">-</div>
                                            <div class="metric-label">Version</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-value" id="system-load">-</div>
                                            <div class="metric-label">System Load</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <div class="metric-value" id="update-status">-</div>
                                            <div class="metric-label">Update Status</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="settings-section" class="content-section" style="display: none;">
                        <h2>System Settings</h2>
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Configuration Management</h5>
                                    <a href="/admin/config" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        Open Config Editor
                                    </a>
                                </div>
                                <div id="config-overview">
                                    <!-- Configuration overview will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Admin Panel JavaScript
        class AdminPanel {
            constructor() {
                this.currentSection = 'dashboard';
                this.refreshInterval = 30000; // 30 seconds
                this.init();
            }
            
            async init() {
                await this.loadDashboardData();
                this.startAutoRefresh();
            }
            
            async loadDashboardData() {
                try {
                    // Load system metrics
                    const [users, sessions, requests, security] = await Promise.all([
                        this.fetchData('/api/v1/admin/accounts'),
                        this.fetchData('/api/v1/admin/sessions'),
                        this.fetchData('/api/v1/cluster/metrics'),
                        this.fetchData('/api/v1/security/audit?quick=true')
                    ]);
                    
                    // Update metrics
                    document.getElementById('total-users').textContent = users?.accounts?.length || 0;
                    document.getElementById('active-sessions').textContent = sessions?.active_count || 0;
                    document.getElementById('api-requests').textContent = requests?.requests_per_minute || 0;
                    document.getElementById('security-score').textContent = security?.audit_result?.audit_summary?.security_score || 0;
                    
                    // Update last update time
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                    
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }
            
            async fetchData(url) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error(`Failed to fetch ${url}:`, error);
                    return null;
                }
            }
            
            startAutoRefresh() {
                setInterval(() => {
                    if (this.currentSection === 'dashboard') {
                        this.loadDashboardData();
                    }
                }, this.refreshInterval);
            }
        }
        
        // Global functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const section = document.getElementById(sectionName + '-section');
            if (section) {
                section.style.display = 'block';
                section.classList.add('fade-in');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update current section
            adminPanel.currentSection = sectionName;
        }
        
        function refreshDashboard() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Refreshing...';
            btn.disabled = true;
            
            adminPanel.loadDashboardData().finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        async function runSecurityAudit() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Running Audit...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/v1/security/audit', { method: 'GET' });
                if (response.ok) {
                    alert('Security audit completed successfully!');
                } else {
                    alert('Security audit failed. Check logs for details.');
                }
            } catch (error) {
                alert('Error running security audit: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function createBackup() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Creating Backup...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/v1/backup/create', { method: 'POST' });
                if (response.ok) {
                    alert('Backup created successfully!');
                } else {
                    alert('Backup creation failed. Check logs for details.');
                }
            } catch (error) {
                alert('Error creating backup: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function runSystemTests() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Running Tests...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/v1/testing/suites/quick_health/run', { method: 'POST' });
                if (response.ok) {
                    alert('System tests completed successfully!');
                } else {
                    alert('System tests failed. Check logs for details.');
                }
            } catch (error) {
                alert('Error running tests: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // System Control Functions
        async function restartApplication() {
            if (!confirm('Are you sure you want to restart the application? This will temporarily interrupt service.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Restarting...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/system/restart', { method: 'POST' });
                if (response.ok) {
                    alert('Application restart initiated. Please wait a moment and refresh the page.');
                } else {
                    alert('Failed to restart application. Check logs for details.');
                }
            } catch (error) {
                alert('Error restarting application: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function reloadConfiguration() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Reloading...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/system/reload-config', { method: 'POST' });
                if (response.ok) {
                    alert('Configuration reloaded successfully!');
                } else {
                    alert('Failed to reload configuration. Check logs for details.');
                }
            } catch (error) {
                alert('Error reloading configuration: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function checkForUpdates() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Checking...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/system/check-updates');
                if (response.ok) {
                    const data = await response.json();
                    if (data.updates_available) {
                        alert(`Updates available! Current: ${data.current_version}, Latest: ${data.latest_version}`);
                    } else {
                        alert('System is up to date!');
                    }
                } else {
                    alert('Failed to check for updates.');
                }
            } catch (error) {
                alert('Error checking for updates: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function updateApplication() {
            if (!confirm('Are you sure you want to update the application? This will restart the service.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Updating...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/system/update', { method: 'POST' });
                if (response.ok) {
                    alert('Update initiated. The application will restart automatically.');
                } else {
                    alert('Failed to start update process.');
                }
            } catch (error) {
                alert('Error updating application: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function clearCache() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Clearing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/performance/cache/clear', { method: 'POST' });
                if (response.ok) {
                    alert('Cache cleared successfully!');
                } else {
                    alert('Failed to clear cache.');
                }
            } catch (error) {
                alert('Error clearing cache: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function optimizeDatabase() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Optimizing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/database/optimize', { method: 'POST' });
                if (response.ok) {
                    alert('Database optimized successfully!');
                } else {
                    alert('Failed to optimize database.');
                }
            } catch (error) {
                alert('Error optimizing database: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function cleanupLogs() {
            if (!confirm('Are you sure you want to cleanup old logs? This action cannot be undone.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner me-1"></span>Cleaning...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/v1/logs/cleanup', { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    alert(`Cleanup completed! Removed ${data.files_removed} old log files, freed ${data.space_freed}MB.`);
                } else {
                    alert('Failed to cleanup logs.');
                }
            } catch (error) {
                alert('Error cleaning up logs: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function emergencyShutdown() {
            if (!confirm('EMERGENCY SHUTDOWN: Are you absolutely sure? This will immediately stop all services.')) {
                return;
            }

            if (!confirm('This is your final warning. Emergency shutdown will stop the application immediately. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/system/emergency-shutdown', { method: 'POST' });
                alert('Emergency shutdown initiated. The application will stop immediately.');
            } catch (error) {
                // Expected - the server will shut down
                alert('Emergency shutdown initiated.');
            }
        }

        // Initialize admin panel
        const adminPanel = new AdminPanel();
    </script>
</body>
</html>
