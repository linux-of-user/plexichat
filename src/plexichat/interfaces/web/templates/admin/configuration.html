{% extends "base.html" %}

{% block title %}Configuration - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.config-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.config-section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: between;
    align-items: center;
}

.config-section-header:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.config-section-body {
    padding: 20px;
    background: #f8f9fa;
}

.config-field {
    margin-bottom: 20px;
}

.config-field label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    display: block;
}

.config-field .field-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 8px;
}

.config-field input,
.config-field select,
.config-field textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.config-field input:focus,
.config-field select:focus,
.config-field textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    outline: none;
}

.config-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-switch.active {
    background: #667eea;
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-switch.active::after {
    transform: translateX(26px);
}

.config-actions {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 20px;
    border-top: 1px solid #dee2e6;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 5px;
}

.validation-warning {
    color: #ffc107;
    font-size: 0.875rem;
    margin-top: 5px;
}

.config-backup {
    background: #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
}

.backup-item:last-child {
    border-bottom: none;
}

.config-wizard {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1050;
    display: none;
}

.wizard-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
}

.wizard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.wizard-body {
    padding: 30px;
}

.wizard-step {
    display: none;
}

.wizard-step.active {
    display: block;
}

.wizard-navigation {
    display: flex;
    justify-content: space-between;
    padding: 20px;
    border-top: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    System Configuration
                </h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openConfigWizard()">
                        <i class="fas fa-magic me-2"></i>
                        Setup Wizard
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportConfig()">
                        <i class="fas fa-download me-2"></i>
                        Export
                    </button>
                    <button class="btn btn-outline-secondary" onclick="importConfig()">
                        <i class="fas fa-upload me-2"></i>
                        Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Backup Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="config-backup">
                <h5><i class="fas fa-history me-2"></i>Configuration Backups</h5>
                <div id="backupList">
                    <!-- Backup list will be populated here -->
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="createBackup()">
                    <i class="fas fa-save me-1"></i>
                    Create Backup
                </button>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <form id="configForm">
        <!-- Server Configuration -->
        <div class="config-section">
            <div class="config-section-header" onclick="toggleSection('server')">
                <div>
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>Server Configuration</h5>
                    <small>Web server and networking settings</small>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="config-section-body" id="server-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="server_host">Host Address</label>
                            <div class="field-description">IP address to bind to (0.0.0.0 for all interfaces)</div>
                            <input type="text" id="server_host" name="server.host" value="0.0.0.0" 
                                   placeholder="0.0.0.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="server_port">Port Number</label>
                            <div class="field-description">TCP port to listen on</div>
                            <input type="number" id="server_port" name="server.port" value="8000" 
                                   min="1" max="65535">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="server_workers">Worker Processes</label>
                            <div class="field-description">Number of worker processes (0 = auto)</div>
                            <input type="number" id="server_workers" name="server.workers" value="4" 
                                   min="1" max="32">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Debug Mode</label>
                            <div class="field-description">Enable debug mode (not for production)</div>
                            <div class="config-toggle">
                                <div class="toggle-switch" id="server_debug" onclick="toggleSwitch(this)"></div>
                                <span>Enable debug mode</span>
                                <input type="hidden" name="server.debug" value="false">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Configuration -->
        <div class="config-section">
            <div class="config-section-header" onclick="toggleSection('security')">
                <div>
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Security Settings</h5>
                    <small>Authentication and security configuration</small>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="config-section-body" id="security-section" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="security_jwt_expire">JWT Token Expiry (minutes)</label>
                            <div class="field-description">How long JWT tokens remain valid</div>
                            <input type="number" id="security_jwt_expire" name="security.jwt_expire_minutes" 
                                   value="30" min="5" max="1440">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="security_password_min">Minimum Password Length</label>
                            <div class="field-description">Minimum required password length</div>
                            <input type="number" id="security_password_min" name="security.password_min_length" 
                                   value="8" min="4" max="128">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Enable HTTPS</label>
                            <div class="field-description">Use HTTPS encryption (requires certificates)</div>
                            <div class="config-toggle">
                                <div class="toggle-switch" id="security_https" onclick="toggleSwitch(this)"></div>
                                <span>Enable HTTPS encryption</span>
                                <input type="hidden" name="security.https_enabled" value="false">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Rate Limiting</label>
                            <div class="field-description">Enable API rate limiting</div>
                            <div class="config-toggle">
                                <div class="toggle-switch active" id="security_rate_limit" onclick="toggleSwitch(this)"></div>
                                <span>Enable rate limiting</span>
                                <input type="hidden" name="security.rate_limiting" value="true">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="https-config" style="display: none;">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="security_cert_file">HTTPS Certificate File</label>
                            <div class="field-description">Path to SSL certificate file</div>
                            <input type="text" id="security_cert_file" name="security.https_cert_file" 
                                   placeholder="/path/to/certificate.crt">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="security_key_file">HTTPS Private Key File</label>
                            <div class="field-description">Path to SSL private key file</div>
                            <input type="text" id="security_key_file" name="security.https_key_file" 
                                   placeholder="/path/to/private.key">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Configuration -->
        <div class="config-section">
            <div class="config-section-header" onclick="toggleSection('features')">
                <div>
                    <h5 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Feature Toggles</h5>
                    <small>Enable or disable PlexiChat features</small>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="config-section-body" id="features-section" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Multi-Server Clustering</label>
                            <div class="field-description">Enable automatic clustering with other PlexiChat instances</div>
                            <div class="config-toggle">
                                <div class="toggle-switch active" id="features_clustering" onclick="toggleSwitch(this)"></div>
                                <span>Enable clustering</span>
                                <input type="hidden" name="features.clustering" value="true">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Hot Updates</label>
                            <div class="field-description">Enable zero-downtime updates</div>
                            <div class="config-toggle">
                                <div class="toggle-switch active" id="features_hot_updates" onclick="toggleSwitch(this)"></div>
                                <span>Enable hot updates</span>
                                <input type="hidden" name="features.hot_updates" value="true">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>File Uploads</label>
                            <div class="field-description">Allow users to upload files</div>
                            <div class="config-toggle">
                                <div class="toggle-switch active" id="features_file_uploads" onclick="toggleSwitch(this)"></div>
                                <span>Enable file uploads</span>
                                <input type="hidden" name="features.file_uploads" value="true">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label>Analytics</label>
                            <div class="field-description">Collect usage analytics and metrics</div>
                            <div class="config-toggle">
                                <div class="toggle-switch active" id="features_analytics" onclick="toggleSwitch(this)"></div>
                                <span>Enable analytics</span>
                                <input type="hidden" name="features.analytics" value="true">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Limits Configuration -->
        <div class="config-section">
            <div class="config-section-header" onclick="toggleSection('limits')">
                <div>
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>System Limits</h5>
                    <small>Resource limits and quotas</small>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="config-section-body" id="limits-section" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="limits_max_file_size">Maximum File Size</label>
                            <div class="field-description">Maximum size for uploaded files (e.g., 10MB, 1GB)</div>
                            <input type="text" id="limits_max_file_size" name="limits.max_file_size" 
                                   value="10MB" placeholder="10MB">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="limits_max_message_length">Maximum Message Length</label>
                            <div class="field-description">Maximum characters per message</div>
                            <input type="number" id="limits_max_message_length" name="limits.max_message_length" 
                                   value="2000" min="100" max="10000">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="limits_rate_limit_requests">Rate Limit (requests)</label>
                            <div class="field-description">Maximum requests per time window</div>
                            <input type="number" id="limits_rate_limit_requests" name="limits.rate_limit_requests" 
                                   value="100" min="10" max="10000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-field">
                            <label for="limits_rate_limit_window">Rate Limit Window (seconds)</label>
                            <div class="field-description">Time window for rate limiting</div>
                            <input type="number" id="limits_rate_limit_window" name="limits.rate_limit_window" 
                                   value="60" min="1" max="3600">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Configuration Actions -->
    <div class="config-actions">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetConfig()">
                    <i class="fas fa-undo me-1"></i>
                    Reset to Defaults
                </button>
                <button type="button" class="btn btn-outline-warning me-2" onclick="validateConfig()">
                    <i class="fas fa-check-circle me-1"></i>
                    Validate
                </button>
            </div>
            <div>
                <button type="button" class="btn btn-secondary me-2" onclick="previewConfig()">
                    <i class="fas fa-eye me-1"></i>
                    Preview Changes
                </button>
                <button type="button" class="btn btn-success" onclick="saveConfig()">
                    <i class="fas fa-save me-1"></i>
                    Save Configuration
                </button>
            </div>
        </div>
        <div id="validationResults" class="mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Configuration Wizard Modal -->
<div class="config-wizard" id="configWizard">
    <div class="wizard-content">
        <div class="wizard-header">
            <h4 class="mb-0">PlexiChat Setup Wizard</h4>
            <p class="mb-0">Configure PlexiChat step by step</p>
        </div>
        <div class="wizard-body">
            <!-- Wizard steps will be populated here -->
        </div>
        <div class="wizard-navigation">
            <button class="btn btn-secondary" onclick="closeConfigWizard()">Cancel</button>
            <div>
                <button class="btn btn-outline-primary" id="wizardPrev" onclick="previousWizardStep()">Previous</button>
                <button class="btn btn-primary" id="wizardNext" onclick="nextWizardStep()">Next</button>
                <button class="btn btn-success" id="wizardFinish" onclick="finishWizard()" style="display: none;">Finish</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfig = {};
let originalConfig = {};
let configSchema = {};

// Initialize configuration interface
document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
    loadBackups();
    loadConfigSchema();
});

// Toggle configuration section
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId + '-section');
    const header = section.previousElementSibling;
    const icon = header.querySelector('i.fa-chevron-down, i.fa-chevron-up');

    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        section.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Toggle switch functionality
function toggleSwitch(element) {
    element.classList.toggle('active');
    const hiddenInput = element.parentElement.querySelector('input[type="hidden"]');
    hiddenInput.value = element.classList.contains('active') ? 'true' : 'false';

    // Handle conditional fields
    if (element.id === 'security_https') {
        const httpsConfig = document.getElementById('https-config');
        httpsConfig.style.display = element.classList.contains('active') ? 'block' : 'none';
    }

    markConfigChanged();
}

// Load current configuration
async function loadConfiguration() {
    try {
        const response = await fetch('/api/v1/config');
        const config = await response.json();

        currentConfig = config;
        originalConfig = JSON.parse(JSON.stringify(config));

        populateConfigForm(config);
    } catch (error) {
        console.error('Failed to load configuration:', error);
        showNotification('Failed to load configuration', 'error');
    }
}

// Populate configuration form
function populateConfigForm(config) {
    // Server configuration
    document.getElementById('server_host').value = config.server?.host || '0.0.0.0';
    document.getElementById('server_port').value = config.server?.port || 8000;
    document.getElementById('server_workers').value = config.server?.workers || 4;
    setToggleState('server_debug', config.server?.debug || false);

    // Security configuration
    document.getElementById('security_jwt_expire').value = config.security?.jwt_expire_minutes || 30;
    document.getElementById('security_password_min').value = config.security?.password_min_length || 8;
    setToggleState('security_https', config.security?.https_enabled || false);
    setToggleState('security_rate_limit', config.security?.rate_limiting !== false);

    if (config.security?.https_cert_file) {
        document.getElementById('security_cert_file').value = config.security.https_cert_file;
    }
    if (config.security?.https_key_file) {
        document.getElementById('security_key_file').value = config.security.https_key_file;
    }

    // Features configuration
    setToggleState('features_clustering', config.features?.clustering !== false);
    setToggleState('features_hot_updates', config.features?.hot_updates !== false);
    setToggleState('features_file_uploads', config.features?.file_uploads !== false);
    setToggleState('features_analytics', config.features?.analytics !== false);

    // Limits configuration
    document.getElementById('limits_max_file_size').value = config.limits?.max_file_size || '10MB';
    document.getElementById('limits_max_message_length').value = config.limits?.max_message_length || 2000;
    document.getElementById('limits_rate_limit_requests').value = config.limits?.rate_limit_requests || 100;
    document.getElementById('limits_rate_limit_window').value = config.limits?.rate_limit_window || 60;

    // Show/hide conditional fields
    const httpsEnabled = config.security?.https_enabled || false;
    document.getElementById('https-config').style.display = httpsEnabled ? 'block' : 'none';
}

// Set toggle switch state
function setToggleState(elementId, state) {
    const toggle = document.getElementById(elementId);
    const hiddenInput = toggle.parentElement.querySelector('input[type="hidden"]');

    if (state) {
        toggle.classList.add('active');
        hiddenInput.value = 'true';
    } else {
        toggle.classList.remove('active');
        hiddenInput.value = 'false';
    }
}

// Collect configuration from form
function collectConfigFromForm() {
    const formData = new FormData(document.getElementById('configForm'));
    const config = {};

    for (const [key, value] of formData.entries()) {
        const keys = key.split('.');
        let current = config;

        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) {
                current[keys[i]] = {};
            }
            current = current[keys[i]];
        }

        // Convert values to appropriate types
        const lastKey = keys[keys.length - 1];
        if (value === 'true') {
            current[lastKey] = true;
        } else if (value === 'false') {
            current[lastKey] = false;
        } else if (!isNaN(value) && value !== '') {
            current[lastKey] = parseInt(value);
        } else {
            current[lastKey] = value;
        }
    }

    return config;
}

// Validate configuration
async function validateConfig() {
    const config = collectConfigFromForm();

    try {
        const response = await fetch('/api/v1/config/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        const result = await response.json();
        displayValidationResults(result);

        return result.valid;
    } catch (error) {
        console.error('Validation failed:', error);
        showNotification('Validation failed', 'error');
        return false;
    }
}

// Display validation results
function displayValidationResults(result) {
    const resultsDiv = document.getElementById('validationResults');
    resultsDiv.innerHTML = '';

    if (result.errors && result.errors.length > 0) {
        const errorsDiv = document.createElement('div');
        errorsDiv.className = 'alert alert-danger';
        errorsDiv.innerHTML = '<strong>Validation Errors:</strong><ul>' +
            result.errors.map(error => `<li>${error}</li>`).join('') + '</ul>';
        resultsDiv.appendChild(errorsDiv);
    }

    if (result.warnings && result.warnings.length > 0) {
        const warningsDiv = document.createElement('div');
        warningsDiv.className = 'alert alert-warning';
        warningsDiv.innerHTML = '<strong>Warnings:</strong><ul>' +
            result.warnings.map(warning => `<li>${warning}</li>`).join('') + '</ul>';
        resultsDiv.appendChild(warningsDiv);
    }

    if (result.valid && (!result.warnings || result.warnings.length === 0)) {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success';
        successDiv.innerHTML = '<strong>✅ Configuration is valid!</strong>';
        resultsDiv.appendChild(successDiv);
    }

    resultsDiv.style.display = 'block';
}

// Save configuration
async function saveConfig() {
    const config = collectConfigFromForm();

    // Validate first
    const isValid = await validateConfig();
    if (!isValid) {
        showNotification('Please fix validation errors before saving', 'error');
        return;
    }

    try {
        const response = await fetch('/api/v1/config', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        const result = await response.json();

        if (result.success) {
            currentConfig = config;
            originalConfig = JSON.parse(JSON.stringify(config));

            showNotification('Configuration saved successfully', 'success');

            if (result.restart_required) {
                showRestartDialog(result.changes);
            }
        } else {
            showNotification('Failed to save configuration: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Save failed:', error);
        showNotification('Failed to save configuration', 'error');
    }
}

// Show restart dialog
function showRestartDialog(changes) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restart Required</h5>
                </div>
                <div class="modal-body">
                    <p>The following changes require a server restart to take effect:</p>
                    <ul>
                        ${changes.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                    <p>Would you like to restart the server now?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
                    <button type="button" class="btn btn-warning" onclick="restartServer()">Restart Now</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Restart server
async function restartServer() {
    try {
        const response = await fetch('/api/v1/system/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({confirm: true, delay: 5})
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Server restart initiated. Page will reload automatically.', 'info');

            // Wait for restart and reload page
            setTimeout(() => {
                window.location.reload();
            }, 10000);
        } else {
            showNotification('Failed to restart server: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Restart failed:', error);
        showNotification('Failed to restart server', 'error');
    }
}

// Reset configuration to defaults
async function resetConfig() {
    if (!confirm('Are you sure you want to reset all configuration to defaults? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/config/defaults');
        const defaultConfig = await response.json();

        populateConfigForm(defaultConfig);
        markConfigChanged();

        showNotification('Configuration reset to defaults', 'info');
    } catch (error) {
        console.error('Reset failed:', error);
        showNotification('Failed to reset configuration', 'error');
    }
}

// Preview configuration changes
function previewConfig() {
    const config = collectConfigFromForm();
    const changes = findConfigChanges(originalConfig, config);

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configuration Changes Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${changes.length > 0 ?
                        '<ul>' + changes.map(change => `<li>${change}</li>`).join('') + '</ul>' :
                        '<p>No changes detected.</p>'
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()" data-bs-dismiss="modal">Save Changes</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Find configuration changes
function findConfigChanges(original, current, prefix = '') {
    const changes = [];

    for (const key in current) {
        const fullKey = prefix ? `${prefix}.${key}` : key;

        if (typeof current[key] === 'object' && current[key] !== null) {
            if (typeof original[key] === 'object' && original[key] !== null) {
                changes.push(...findConfigChanges(original[key], current[key], fullKey));
            } else {
                changes.push(`${fullKey}: added`);
            }
        } else if (original[key] !== current[key]) {
            changes.push(`${fullKey}: ${original[key]} → ${current[key]}`);
        }
    }

    return changes;
}

// Mark configuration as changed
function markConfigChanged() {
    // Add visual indicator that config has changed
    document.title = '• Configuration - PlexiChat';
}

// Load configuration backups
async function loadBackups() {
    try {
        const response = await fetch('/api/v1/config/backups');
        const backups = await response.json();

        const backupList = document.getElementById('backupList');
        backupList.innerHTML = '';

        if (backups.length === 0) {
            backupList.innerHTML = '<p class="text-muted">No backups available</p>';
            return;
        }

        backups.forEach(backup => {
            const backupItem = document.createElement('div');
            backupItem.className = 'backup-item';
            backupItem.innerHTML = `
                <div>
                    <strong>${backup.filename}</strong>
                    <br>
                    <small class="text-muted">
                        Created: ${new Date(backup.created).toLocaleString()}
                        (${formatFileSize(backup.size)})
                    </small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="restoreBackup('${backup.path}')">
                        <i class="fas fa-undo"></i> Restore
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.path}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            backupList.appendChild(backupItem);
        });
    } catch (error) {
        console.error('Failed to load backups:', error);
    }
}

// Create configuration backup
async function createBackup() {
    try {
        const response = await fetch('/api/v1/config/backup', {method: 'POST'});
        const result = await response.json();

        if (result.success) {
            showNotification('Backup created successfully', 'success');
            loadBackups();
        } else {
            showNotification('Failed to create backup: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Backup creation failed:', error);
        showNotification('Failed to create backup', 'error');
    }
}

// Restore configuration backup
async function restoreBackup(backupPath) {
    if (!confirm('Are you sure you want to restore this backup? Current configuration will be lost.')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/config/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({backup_path: backupPath})
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Backup restored successfully', 'success');
            loadConfiguration();
        } else {
            showNotification('Failed to restore backup: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Backup restoration failed:', error);
        showNotification('Failed to restore backup', 'error');
    }
}

// Delete configuration backup
async function deleteBackup(backupPath) {
    if (!confirm('Are you sure you want to delete this backup?')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/config/backup', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({backup_path: backupPath})
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Backup deleted successfully', 'success');
            loadBackups();
        } else {
            showNotification('Failed to delete backup: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Backup deletion failed:', error);
        showNotification('Failed to delete backup', 'error');
    }
}

// Export configuration
function exportConfig() {
    const config = collectConfigFromForm();
    const dataStr = JSON.stringify(config, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `plexichat_config_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Import configuration
function importConfig() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.yaml,.yml';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                populateConfigForm(config);
                markConfigChanged();
                showNotification('Configuration imported successfully', 'success');
            } catch (error) {
                showNotification('Failed to import configuration: Invalid JSON', 'error');
            }
        };
        reader.readAsText(file);
    };

    input.click();
}

// Utility functions
function formatFileSize(bytes) {
    const sizes = ['B', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 B';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Configuration wizard functions
function openConfigWizard() {
    document.getElementById('configWizard').style.display = 'block';
    initializeWizard();
}

function closeConfigWizard() {
    document.getElementById('configWizard').style.display = 'none';
}

function initializeWizard() {
    // Initialize wizard steps
    // This would contain the wizard implementation
}

function nextWizardStep() {
    // Navigate to next wizard step
}

function previousWizardStep() {
    // Navigate to previous wizard step
}

function finishWizard() {
    // Complete wizard and apply configuration
    closeConfigWizard();
}

// Load configuration schema
async function loadConfigSchema() {
    try {
        const response = await fetch('/api/v1/config/schema');
        configSchema = await response.json();
    } catch (error) {
        console.error('Failed to load config schema:', error);
    }
}
</script>
{% endblock %}
