<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlexiChat Enhanced Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-bg: #1a1a1a;
            --card-bg: #2d3748;
            --text-light: #e2e8f0;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .admin-header {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--accent-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .admin-nav {
            background: var(--card-bg);
            border-radius: 10px;
            margin: 1rem 0;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .nav-pills .nav-link {
            color: var(--text-light);
            border-radius: 8px;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link.active {
            background: var(--accent-color);
            color: white;
        }

        .nav-pills .nav-link:hover {
            background: rgba(52, 152, 219, 0.2);
            color: white;
        }

        .admin-card {
            background: var(--card-bg);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .admin-card .card-header {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
            border: none;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(52, 152, 219, 0.1));
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
            border-color: var(--accent-color);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
            color: white;
        }

        .table-dark {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-dark th {
            background: var(--primary-color);
            border-color: rgba(52, 152, 219, 0.3);
            color: var(--text-light);
        }

        .table-dark td {
            border-color: rgba(52, 152, 219, 0.2);
            color: var(--text-light);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online { background: var(--success-color); color: white; }
        .status-offline { background: var(--danger-color); color: white; }
        .status-warning { background: var(--warning-color); color: white; }
        .status-active { background: var(--success-color); color: white; }
        .status-inactive { background: var(--danger-color); color: white; }

        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-custom .progress-bar {
            border-radius: 4px;
        }

        .alert-custom {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            color: var(--text-light);
        }

        .form-control-dark {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            color: var(--text-light);
            border-radius: 8px;
        }

        .form-control-dark:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-control-dark::placeholder {
            color: rgba(226, 232, 240, 0.6);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-content {
            padding: 2rem 0;
        }

        .security-level-top-secret {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .security-level-secret {
            border-left: 4px solid #fd7e14;
            background: rgba(253, 126, 20, 0.1);
        }

        .security-level-confidential {
            border-left: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .security-level-unclassified {
            border-left: 4px solid #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-shield-alt text-primary"></i>
                        PlexiChat Enhanced Admin Dashboard
                    </h1>
                    <small class="text-muted">Government-Level Secure Communication Platform</small>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <small class="text-muted">System Status:</small>
                            <span class="status-badge status-online ms-1">OPERATIONAL</span>
                        </div>
                        <div class="me-3">
                            <small class="text-muted">Security Level:</small>
                            <span class="status-badge" style="background: #ffc107; color: #000;">CONFIDENTIAL</span>
                        </div>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Navigation -->
        <div class="admin-nav">
            <ul class="nav nav-pills justify-content-center" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="backup-tab" data-bs-toggle="pill" data-bs-target="#backup" type="button" role="tab">
                        <i class="fas fa-database"></i> Backup System
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab">
                        <i class="fas fa-users"></i> User Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="moderation-tab" data-bs-toggle="pill" data-bs-target="#moderation" type="button" role="tab">
                        <i class="fas fa-gavel"></i> Moderation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-tab" data-bs-toggle="pill" data-bs-target="#security" type="button" role="tab">
                        <i class="fas fa-lock"></i> Security
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="nodes-tab" data-bs-toggle="pill" data-bs-target="#nodes" type="button" role="tab">
                        <i class="fas fa-server"></i> Backup Nodes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitoring-tab" data-bs-toggle="pill" data-bs-target="#monitoring" type="button" role="tab">
                        <i class="fas fa-chart-line"></i> Monitoring
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- System Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">-</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalMessages">-</div>
                            <div class="stat-label">Total Messages</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalBackups">-</div>
                            <div class="stat-label">Active Backups</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="systemUptime">-</div>
                            <div class="stat-label">System Uptime</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Activity</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentActivity">
                                    <div class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p class="mt-2">Loading recent activity...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> System Alerts</h5>
                            </div>
                            <div class="card-body">
                                <div id="systemAlerts">
                                    <div class="alert alert-custom">
                                        <i class="fas fa-info-circle"></i>
                                        System operating normally. All security protocols active.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup System Tab -->
            <div class="tab-pane fade" id="backup" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-database"></i> Government-Level Backup System</h5>
                                <button class="btn btn-admin" onclick="createBackup()">
                                    <i class="fas fa-plus"></i> Create Backup
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Backup Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="backupCount">-</div>
                                            <div class="stat-label">Total Backups</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalShards">-</div>
                                            <div class="stat-label">Total Shards</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="redundancyFactor">5x</div>
                                            <div class="stat-label">Redundancy Factor</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="backupStorage">-</div>
                                            <div class="stat-label">Storage Used (GB)</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Backup List -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Backup Name</th>
                                                <th>Type</th>
                                                <th>Security Level</th>
                                                <th>Size</th>
                                                <th>Shards</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backupList">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                    Loading backups...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shard Distribution Map -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-map"></i> Shard Distribution Network</h5>
                            </div>
                            <div class="card-body">
                                <div id="shardDistributionChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users"></i> User Management</h5>
                                <div>
                                    <button class="btn btn-admin me-2" onclick="exportUsers()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-admin" onclick="createUser()">
                                        <i class="fas fa-user-plus"></i> Add User
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- User Search -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control form-control-dark" id="userSearch" placeholder="Search users...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-control form-control-dark" id="userStatusFilter">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="banned">Banned</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-admin w-100" onclick="searchUsers()">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>

                                <!-- User List -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Username</th>
                                                <th>Email</th>
                                                <th>Display Name</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Last Activity</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userList">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                    Loading users...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moderation Tab -->
            <div class="tab-pane fade" id="moderation" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-gavel"></i> Moderation Dashboard</h5>
                            </div>
                            <div class="card-body">
                                <!-- Moderation Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="pendingReports">-</div>
                                            <div class="stat-label">Pending Reports</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="activeBans">-</div>
                                            <div class="stat-label">Active Bans</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="activeMutes">-</div>
                                            <div class="stat-label">Active Mutes</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="moderatorCount">-</div>
                                            <div class="stat-label">Active Moderators</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Moderation Actions -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Action</th>
                                                <th>Target User</th>
                                                <th>Moderator</th>
                                                <th>Reason</th>
                                                <th>Severity</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="moderationList">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                    Loading moderation logs...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Security Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Encryption Status</label>
                                    <div class="d-flex align-items-center">
                                        <span class="status-badge status-active me-2">AES-256-GCM</span>
                                        <small class="text-muted">Government Grade</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Authentication</label>
                                    <div class="d-flex align-items-center">
                                        <span class="status-badge status-active me-2">ACTIVE</span>
                                        <small class="text-muted">Multi-Factor Enabled</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Backup Encryption</label>
                                    <div class="d-flex align-items-center">
                                        <span class="status-badge status-active me-2">PBKDF2</span>
                                        <small class="text-muted">200,000 Iterations</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bug"></i> Security Scan</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-admin w-100 mb-3" onclick="runSecurityScan()">
                                    <i class="fas fa-search"></i> Run Security Scan
                                </button>
                                <div id="securityScanResults">
                                    <div class="alert alert-custom">
                                        <i class="fas fa-info-circle"></i>
                                        Last scan: Never. Click to run initial security assessment.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup Nodes Tab -->
            <div class="tab-pane fade" id="nodes" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-server"></i> Backup Node Network</h5>
                                <button class="btn btn-admin" onclick="addBackupNode()">
                                    <i class="fas fa-plus"></i> Add Node
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Node Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalNodes">-</div>
                                            <div class="stat-label">Total Nodes</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="onlineNodes">-</div>
                                            <div class="stat-label">Online Nodes</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalCapacity">-</div>
                                            <div class="stat-label">Total Capacity (TB)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number" id="usedCapacity">-</div>
                                            <div class="stat-label">Used Capacity (%)</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Node List -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Node Name</th>
                                                <th>Type</th>
                                                <th>Endpoint</th>
                                                <th>Capacity</th>
                                                <th>Usage</th>
                                                <th>Status</th>
                                                <th>Security Level</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="nodeList">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                    Loading backup nodes...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div class="tab-pane fade" id="monitoring" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-line"></i> System Performance</h5>
                            </div>
                            <div class="card-body">
                                <div id="performanceChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-hdd"></i> Storage Usage</h5>
                            </div>
                            <div class="card-body">
                                <div id="storageChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="admin-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-network-wired"></i> Network Activity</h5>
                            </div>
                            <div class="card-body">
                                <div id="networkChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="modal fade" id="adminResetPasswordModal" tabindex="-1" aria-labelledby="adminResetPasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adminResetPasswordModalLabel">Reset Admin Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="admin-reset-password-form">
              <input type="hidden" id="reset-admin-username" name="username">
              <div class="mb-3">
                <label for="reset-admin-new-password" class="form-label">New Password</label>
                <input type="password" class="form-control" id="reset-admin-new-password" name="new_password" required>
              </div>
              <div class="mb-3" id="reset-admin-current-password-group" style="display:none;">
                <label for="reset-admin-current-password" class="form-label">Current Password</label>
                <input type="password" class="form-control" id="reset-admin-current-password" name="current_password">
              </div>
              <div id="admin-reset-password-message" class="alert" style="display:none;"></div>
              <button type="submit" class="btn btn-admin w-100">Reset Password</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js"></script>
    <script>
        // Global variables
        let charts = {};
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startAutoRefresh();
        });

        async function initializeDashboard() {
            await loadOverviewData();
            await loadBackupData();
            await loadUserData();
            await loadModerationData();
            await loadNodeData();
            initializeCharts();
        }

        async function loadOverviewData() {
            try {
                // Load system statistics
                const response = await fetch('/api/v1/admin/statistics');
                const data = await response.json();

                document.getElementById('totalUsers').textContent = data.total_users || 0;
                document.getElementById('totalMessages').textContent = data.total_messages || 0;
                document.getElementById('totalBackups').textContent = data.total_backups || 0;
                document.getElementById('systemUptime').textContent = formatUptime(data.uptime_seconds || 0);

                // Load recent activity
                await loadRecentActivity();

            } catch (error) {
                console.error('Error loading overview data:', error);
                showError('Failed to load overview data');
            }
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/v1/admin/recent-activity');
                const activities = await response.json();

                const activityHtml = activities.map(activity => `
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-3">
                            <i class="fas fa-${getActivityIcon(activity.type)} text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <small class="text-muted">${formatDateTime(activity.timestamp)}</small>
                            <div>${activity.description}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">No recent activity</p>';

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = '<p class="text-danger">Failed to load activity</p>';
            }
        }

        async function loadBackupData() {
            try {
                const response = await fetch('/api/v1/backup/statistics');
                const data = await response.json();

                document.getElementById('backupCount').textContent = data.backups?.total_count || 0;
                document.getElementById('totalShards').textContent = data.total_shards || 0;
                document.getElementById('backupStorage').textContent = (data.backups?.total_storage_gb || 0).toFixed(2);

                // Load backup list
                await loadBackupList();

            } catch (error) {
                console.error('Error loading backup data:', error);
                showError('Failed to load backup data');
            }
        }

        async function loadBackupList() {
            try {
                const response = await fetch('/api/v1/backup/list?limit=10');
                const backups = await response.json();

                const backupHtml = backups.map(backup => `
                    <tr>
                        <td>${backup.backup_name}</td>
                        <td><span class="badge bg-secondary">${backup.backup_type}</span></td>
                        <td><span class="badge ${getSecurityLevelClass(backup.security_level)}">${backup.security_level}</span></td>
                        <td>${(backup.total_size_gb || 0).toFixed(2)} GB</td>
                        <td>${backup.shard_count || 0}</td>
                        <td><span class="status-badge ${getStatusClass(backup.status)}">${backup.status}</span></td>
                        <td>${formatDateTime(backup.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBackup(${backup.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="recoverBackup(${backup.id})">
                                <i class="fas fa-undo"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('backupList').innerHTML = backupHtml || '<tr><td colspan="8" class="text-center text-muted">No backups found</td></tr>';

            } catch (error) {
                console.error('Error loading backup list:', error);
                document.getElementById('backupList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load backups</td></tr>';
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/v1/users/search?limit=10');
                const users = await response.json();

                const userHtml = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.display_name || user.username}</td>
                        <td><span class="status-badge ${getStatusClass(user.status)}">${user.status}</span></td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td>${formatDateTime(user.last_activity_at) || 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openResetPasswordModal(user.username)">
                                <i class="fas fa-key"></i> Reset Password
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('userList').innerHTML = userHtml || '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';

            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('userList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }

        async function loadModerationData() {
            try {
                const response = await fetch('/api/v1/moderation/logs?limit=10');
                const logs = await response.json();

                document.getElementById('pendingReports').textContent = logs.filter(l => l.status === 'pending').length;
                document.getElementById('activeBans').textContent = logs.filter(l => l.action === 'ban' && l.status === 'active').length;
                document.getElementById('activeMutes').textContent = logs.filter(l => l.action === 'mute' && l.status === 'active').length;

                const moderationHtml = logs.map(log => `
                    <tr>
                        <td><span class="badge bg-info">${log.action}</span></td>
                        <td>${log.target_user?.username || 'N/A'}</td>
                        <td>${log.moderator?.username || 'System'}</td>
                        <td>${log.reason}</td>
                        <td><span class="badge ${getSeverityClass(log.severity)}">${log.severity}</span></td>
                        <td>${formatDateTime(log.created_at)}</td>
                        <td><span class="status-badge ${getStatusClass(log.status)}">${log.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewModerationLog(${log.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('moderationList').innerHTML = moderationHtml || '<tr><td colspan="8" class="text-center text-muted">No moderation logs found</td></tr>';

            } catch (error) {
                console.error('Error loading moderation data:', error);
                showError('Failed to load moderation data');
            }
        }

        async function loadNodeData() {
            try {
                const response = await fetch('/api/v1/backup/nodes/list');
                const nodes = await response.json();

                document.getElementById('totalNodes').textContent = nodes.length;
                document.getElementById('onlineNodes').textContent = nodes.filter(n => n.status.is_online).length;

                const totalCapacity = nodes.reduce((sum, node) => sum + node.capacity.total_gb, 0);
                const avgUtilization = nodes.length > 0 ? nodes.reduce((sum, node) => sum + node.capacity.utilization_percent, 0) / nodes.length : 0;

                document.getElementById('totalCapacity').textContent = (totalCapacity / 1000).toFixed(1);
                document.getElementById('usedCapacity').textContent = avgUtilization.toFixed(1) + '%';

                const nodeHtml = nodes.map(node => `
                    <tr>
                        <td>${node.node_name}</td>
                        <td><span class="badge bg-secondary">${node.node_type}</span></td>
                        <td>${node.endpoint_url}</td>
                        <td>${node.capacity.total_gb.toFixed(1)} GB</td>
                        <td>
                            <div class="progress progress-custom">
                                <div class="progress-bar ${getUtilizationClass(node.capacity.utilization_percent)}"
                                     style="width: ${node.capacity.utilization_percent}%"></div>
                            </div>
                            <small>${node.capacity.utilization_percent.toFixed(1)}%</small>
                        </td>
                        <td><span class="status-badge ${node.status.is_online ? 'status-online' : 'status-offline'}">${node.status.is_online ? 'Online' : 'Offline'}</span></td>
                        <td><span class="badge ${getSecurityLevelClass(node.security_level)}">${node.security_level}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewNode(${node.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="testNode(${node.id})">
                                <i class="fas fa-vial"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('nodeList').innerHTML = nodeHtml || '<tr><td colspan="8" class="text-center text-muted">No backup nodes found</td></tr>';

            } catch (error) {
                console.error('Error loading node data:', error);
                showError('Failed to load node data');
            }
        }

        function initializeCharts() {
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx) {
                charts.performance = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: ['1h ago', '45m ago', '30m ago', '15m ago', 'Now'],
                        datasets: [{
                            label: 'CPU Usage (%)',
                            data: [45, 52, 48, 61, 55],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Memory Usage (%)',
                            data: [62, 65, 68, 70, 67],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#e2e8f0' } },
                            y: { ticks: { color: '#e2e8f0' } }
                        }
                    }
                });
            }

            // Storage Chart
            const storageCtx = document.getElementById('storageChart');
            if (storageCtx) {
                charts.storage = new Chart(storageCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Used', 'Available'],
                        datasets: [{
                            data: [65, 35],
                            backgroundColor: ['#3498db', '#2c3e50'],
                            borderColor: ['#3498db', '#2c3e50'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        }
                    }
                });
            }
        }

        // Utility functions
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            return `${days}d ${hours}h`;
        }

        function getActivityIcon(type) {
            const icons = {
                'user_login': 'sign-in-alt',
                'backup_created': 'database',
                'message_sent': 'comment',
                'user_registered': 'user-plus',
                'moderation_action': 'gavel'
            };
            return icons[type] || 'info-circle';
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'status-active',
                'online': 'status-online',
                'completed': 'status-active',
                'failed': 'status-offline',
                'pending': 'status-warning',
                'inactive': 'status-inactive'
            };
            return classes[status] || 'status-warning';
        }

        function getSecurityLevelClass(level) {
            const classes = {
                'top_secret': 'bg-danger',
                'secret': 'bg-warning',
                'confidential': 'bg-info',
                'unclassified': 'bg-success'
            };
            return classes[level] || 'bg-secondary';
        }

        function getSeverityClass(severity) {
            const classes = {
                'critical': 'bg-danger',
                'high': 'bg-warning',
                'medium': 'bg-info',
                'low': 'bg-success'
            };
            return classes[severity] || 'bg-secondary';
        }

        function getUtilizationClass(percent) {
            if (percent > 90) return 'bg-danger';
            if (percent > 75) return 'bg-warning';
            if (percent > 50) return 'bg-info';
            return 'bg-success';
        }

        function showError(message) {
            // Simple error display - could be enhanced with toast notifications
            console.error(message);
        }

        function showSuccess(message) {
            // Simple success display - could be enhanced with toast notifications
            console.log(message);
        }

        // Action functions
        async function createBackup() {
            try {
                const response = await fetch('/api/v1/backup/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        backup_name: `backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}`,
                        security_level: 'confidential'
                    })
                });

                if (response.ok) {
                    showSuccess('Backup creation started');
                    await loadBackupData();
                } else {
                    showError('Failed to create backup');
                }
            } catch (error) {
                showError('Error creating backup: ' + error.message);
            }
        }

        async function refreshDashboard() {
            await initializeDashboard();
            showSuccess('Dashboard refreshed');
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(async () => {
                await loadOverviewData();
            }, 30000); // Refresh every 30 seconds
        }

        // Placeholder functions for other actions
        function viewBackup(id) { console.log('View backup:', id); }
        function recoverBackup(id) { console.log('Recover backup:', id); }
        function editUser(id) { console.log('Edit user:', id); }
        function moderateUser(id) { console.log('Moderate user:', id); }
        function viewModerationLog(id) { console.log('View moderation log:', id); }
        function viewNode(id) { console.log('View node:', id); }
        function testNode(id) { console.log('Test node:', id); }
        function createUser() { console.log('Create user'); }
        function exportUsers() { console.log('Export users'); }
        function searchUsers() { console.log('Search users'); }
        function addBackupNode() { console.log('Add backup node'); }
        function runSecurityScan() { console.log('Run security scan'); }

        function openResetPasswordModal(username) {
            document.getElementById('reset-admin-username').value = username;
            // If self, show current password field
            const currentUser = window.currentAdminUsername || '';
            if (username === currentUser) {
                document.getElementById('reset-admin-current-password-group').style.display = '';
            } else {
                document.getElementById('reset-admin-current-password-group').style.display = 'none';
            }
            document.getElementById('admin-reset-password-message').style.display = 'none';
            var modal = new bootstrap.Modal(document.getElementById('adminResetPasswordModal'));
            modal.show();
        }
    </script>
</body>
</html>
